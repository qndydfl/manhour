<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <title>ì‘ì—… ì„¸ì…˜ ì‹œì‘</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
    </head>
    <body class="bg-light">
        <div class="text-end mb-3">
            <a
                href="{% url 'history' %}"
                class="btn btn-link text-decoration-none fw-bold"
            >
                ğŸ“œ ì§€ë‚œ ê¸°ë¡ ë³´ê¸°
            </a>
        </div>

        <div class="container mt-5" style="max-width: 800px">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">âœˆï¸ ì˜¤ëŠ˜ì˜ ì‘ì—… ì‹œì‘í•˜ê¸°</h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="form-label fw-bold"
                                >1ï¸âƒ£ ì„¸ì…˜ ì„ íƒ (ì˜¤ëŠ˜ ì‚¬ìš©í•  ì‘ì—… ê³µê°„)</label
                            >

                            <input
                                type="hidden"
                                name="session_name"
                                id="selected_session"
                                required
                            />

                            <div class="row g-2">
                                {% for slot in slots %}
                                <div class="col-6 col-md-3">
                                    <button
                                        type="button"
                                        class="btn w-100 py-3 fw-bold session-btn {% if slot.is_taken %}btn-secondary disabled{% else %}btn-outline-primary{% endif %}"
                                        onclick="selectSession('{{ slot.name }}', this)"
                                        {%
                                        if
                                        slot.is_taken
                                        %}disabled{%
                                        endif
                                        %}
                                    >
                                        {{ slot.name }} {% if slot.is_taken %}
                                        <br /><span class="badge bg-dark small"
                                            >ì‚¬ìš© ì¤‘</span
                                        >
                                        {% else %}
                                        <br /><span
                                            class="badge bg-success small"
                                            >ê°€ëŠ¥</span
                                        >
                                        {% endif %}
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text mt-2" id="selection_msg">
                                ì‘ì—…í•  ì„¸ì…˜ì„ í´ë¦­í•˜ì„¸ìš”.
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold"
                                    >2ï¸âƒ£ ì‘ì—…ì ëª…ë‹¨</label
                                >
                                <textarea
                                    name="worker_names"
                                    class="form-control"
                                    rows="5"
                                    placeholder="ê¹€ì² ìˆ˜, ì´ì˜í¬ (ì—”í„°ë¡œ êµ¬ë¶„)"
                                    required
                                ></textarea>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold"
                                    >3ï¸âƒ£ í•­ê³µê¸° ê¸°ë²ˆ</label
                                >
                                <div
                                    id="gibunContainer"
                                    class="form-control d-flex flex-wrap gap-2 align-items-center"
                                    style="min-height: 45px; cursor: text"
                                >
                                    <input
                                        type="text"
                                        id="gibunInput"
                                        style="
                                            border: none;
                                            outline: none;
                                            background: transparent;
                                            min-width: 100px;
                                            flex-grow: 1;
                                        "
                                        placeholder="ê¸°ë²ˆ ì…ë ¥ í›„ ì—”í„° (ì˜ˆ: HL7777)"
                                    />
                                </div>
                                <div class="form-text">
                                    ì—¬ëŸ¬ ëŒ€ì¼ ê²½ìš° ì—”í„°(Enter) ë˜ëŠ” ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ
                                    êµ¬ë¶„í•˜ì„¸ìš”.
                                </div>

                                <input
                                    type="hidden"
                                    name="gibun_input"
                                    id="realGibunField"
                                />
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button
                                type="submit"
                                class="btn btn-success flex-fill py-3 fw-bold fs-5"
                                id="submitBtn"
                                disabled
                            >
                                ğŸš€ ì‘ì—… ì‹œì‘í•˜ê¸°
                            </button>
                            <button
                                type="button"
                                id="cancelBtn"
                                class="btn btn-outline-secondary py-3 fw-bold"
                                onclick="resetForm()"
                            >
                                âŒ ì·¨ì†Œ
                            </button>
                            <a
                                href="{% url 'home' %}"
                                class="btn btn-light py-3 fw-bold"
                                >ğŸ  í™ˆìœ¼ë¡œ ì´ë™</a
                            >
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            function selectSession(name, btnElement) {
                // 1. ìˆ¨ê²¨ì§„ ì¹¸ì— ì´ë¦„ ë„£ê¸°
                document.getElementById("selected_session").value = name;

                // 2. ëª¨ë“  ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                document.querySelectorAll(".session-btn").forEach((btn) => {
                    if (!btn.disabled) {
                        btn.classList.remove("btn-primary", "text-white");
                        btn.classList.add("btn-outline-primary");
                    }
                });

                // 3. ì„ íƒí•œ ë²„íŠ¼ë§Œ ìƒ‰ì¹ í•˜ê¸°
                btnElement.classList.remove("btn-outline-primary");
                btnElement.classList.add("btn-primary", "text-white");

                // 4. ë©”ì‹œì§€ ë° ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
                document.getElementById("selection_msg").innerText =
                    "âœ… ì„ íƒë¨: " + name;
                document
                    .getElementById("selection_msg")
                    .classList.add("text-primary", "fw-bold");
                document.getElementById("submitBtn").disabled = false;
            }

            const gibunContainer = document.getElementById("gibunContainer");
            const gibunInput = document.getElementById("gibunInput");
            const realGibunField = document.getElementById("realGibunField");

            let gibunList = []; // ê¸°ë²ˆë“¤ì„ ë‹´ì„ ë°°ì—´

            // 1. ì»¨í…Œì´ë„ˆ ì•„ë¬´ë°ë‚˜ í´ë¦­í•´ë„ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            gibunContainer.addEventListener("click", () => gibunInput.focus());

            // 2. í‚¤ ì…ë ¥ ê°ì§€ (ì—”í„°, ìŠ¤í˜ì´ìŠ¤, ì‰¼í‘œ)
            gibunInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter" || e.key === "," || e.key === " ") {
                    e.preventDefault(); // í¼ ì „ì†¡ ë§‰ê¸°
                    addGibun(this.value);
                    this.value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                }
                // ë°±ìŠ¤í˜ì´ìŠ¤ë¡œ ë§ˆì§€ë§‰ íƒœê·¸ ì‚­ì œ
                if (
                    e.key === "Backspace" &&
                    this.value === "" &&
                    gibunList.length > 0
                ) {
                    removeGibun(gibunList.length - 1);
                }
            });

            // 3. ê¸°ë²ˆ ì¶”ê°€ í•¨ìˆ˜
            function addGibun(text) {
                // ê³µë°± ì œê±° ë° ëŒ€ë¬¸ì ë³€í™˜
                const cleanText = text.trim().toUpperCase();

                // ë¹ˆ ê°’ì´ë‚˜ ì´ë¯¸ ìˆëŠ” ê°’ì€ ì œì™¸
                if (cleanText === "" || gibunList.includes(cleanText)) return;

                gibunList.push(cleanText);
                updateRealField();
                renderTags();
            }

            // 4. ê¸°ë²ˆ ì‚­ì œ í•¨ìˆ˜
            function removeGibun(index) {
                gibunList.splice(index, 1);
                updateRealField();
                renderTags();
            }

            // 5. í™”ë©´ ê·¸ë¦¬ê¸° (íƒœê·¸ ë Œë”ë§)
            function renderTags() {
                // ê¸°ì¡´ íƒœê·¸ë“¤ ì§€ìš°ê³  (inputì€ ë‚¨ê¹€)
                const currentTags = gibunContainer.querySelectorAll(".badge");
                currentTags.forEach((tag) => tag.remove());

                // ë°°ì—´ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ì‹œ ê·¸ë¦¼
                gibunList.forEach((gibun, index) => {
                    const badge = document.createElement("span");
                    badge.className =
                        "badge bg-primary d-flex align-items-center";
                    badge.style.fontSize = "0.9rem";
                    badge.style.padding = "8px 12px";
                    badge.innerHTML = `
                    ${gibun}
                    <i class="bi bi-x ms-2" style="cursor: pointer;" onclick="removeGibun(${index})"></i>
                `;
                    // input ì•ì— ì‚½ì…
                    gibunContainer.insertBefore(badge, gibunInput);
                });
            }

            // 6. ìˆ¨ê²¨ì§„ inputì— ê°’ ì—…ë°ì´íŠ¸ (ì„œë²„ ì „ì†¡ìš©)
            function updateRealField() {
                // ë°°ì—´ì„ ì½¤ë§ˆ(,)ë¡œ ì—°ê²°í•´ì„œ ë¬¸ìì—´ë¡œ ë§Œë“¦
                realGibunField.value = gibunList.join(",");
            }

            // 7. í¼ ë¦¬ì…‹/ì·¨ì†Œ ì²˜ë¦¬
            function resetForm() {
                // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                document.getElementById("selected_session").value = "";
                document.getElementById("selection_msg").innerText =
                    "ì‘ì—…í•  ì„¸ì…˜ì„ í´ë¦­í•˜ì„¸ìš”.";
                document
                    .getElementById("selection_msg")
                    .classList.remove("text-primary", "fw-bold");
                document.getElementById("submitBtn").disabled = true;

                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì›ë³µ
                document.querySelectorAll(".session-btn").forEach((btn) => {
                    if (!btn.disabled) {
                        btn.classList.remove("btn-primary", "text-white");
                        btn.classList.add("btn-outline-primary");
                    }
                });

                // ì‘ì—…ì ëª©ë¡ ë° ê¸°ë²ˆ ì´ˆê¸°í™”
                const workerArea = document.querySelector(
                    'textarea[name="worker_names"]'
                );
                if (workerArea) workerArea.value = "";
                gibunList = [];
                renderTags();
                updateRealField();
            }
        </script>
    </body>
</html>
