{% extends "manning/base/base.html" %}
{% load static %}

<title>{% block title %}ì‘ì—… ì„¸ì…˜ ì‹œì‘{% endblock title %}</title>

<script defer src="{% static 'js/create_session.js' %}"></script>


{% block js %}
{% comment %} <script>
    const CHECK_GIBUN_URL = "{% url 'check_gibun' %}";
    // // ----------------------------------------------------------------
    // // 1. ì„¸ì…˜ ì„ íƒ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
    // // ----------------------------------------------------------------
    function selectSession(name, btnElement) {
        document.getElementById("selected_session").value = name;
        document.querySelectorAll(".session-btn").forEach((btn) => {
            if (!btn.disabled) {
                btn.classList.remove("btn-primary", "text-white");
                btn.classList.add("btn-outline-primary");
            }
        });
        btnElement.classList.remove("btn-outline-primary");
        btnElement.classList.add("btn-primary", "text-white");
        const msgEl = document.getElementById("selection_msg");
        msgEl.innerText = "âœ… ì„ íƒë¨: " + name;
        msgEl.classList.add("text-primary", "fw-bold");
        checkFormValidity();
    }

    // // ----------------------------------------------------------------
    // // 2. ê¸°ë²ˆ íƒœê·¸ ì…ë ¥ ë¡œì§ (ì¤‘ë³µ ì…ë ¥ ë°©ì§€ ì¶”ê°€)
    // // ----------------------------------------------------------------
    const gibunContainer = document.getElementById("gibunContainer");
    const gibunInput = document.getElementById("gibunInput");
    const realGibunField = document.getElementById("realGibunField");
    const gibunWarning = document.getElementById("gibunWarning");

    let gibunList = [];
    let isProcessing = false; // [í•µì‹¬] ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸

    // ì»¨í…Œì´ë„ˆ í´ë¦­ ì‹œ ì…ë ¥ì°½ í¬ì»¤ìŠ¤
    gibunContainer.addEventListener("click", (e) => {
        if (e.target === gibunContainer || e.target === gibunInput) {
            gibunInput.focus();
        }
    });

    // í‚¤ë³´ë“œ ì…ë ¥ ì´ë²¤íŠ¸
    gibunInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" || e.key === "," || e.key === " ") {
            e.preventDefault();
            e.stopPropagation();
            // ì²˜ë¦¬ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰
            if (!isProcessing) {
                addGibun(this.value);
            }
        }
        if (
            e.key === "Backspace" &&
            this.value === "" &&
            gibunList.length > 0
        ) {
            removeGibun(gibunList.length - 1);
        }
    });

    // í¬ì»¤ìŠ¤ ìƒì—ˆì„ ë•Œ ì €ì¥
    gibunInput.addEventListener("blur", function () {
        // ê°’ì´ ìˆê³ , í˜„ì¬ ì²˜ë¦¬ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰
        if (this.value.trim() && !isProcessing) {
            addGibun(this.value);
        }
    });

    // [ìˆ˜ì •ë¨] ê¸°ë²ˆ ì¶”ê°€ ë° ì„œë²„ ê²€ì¦ í•¨ìˆ˜
    async function addGibun(text) {
        if (isProcessing) return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë‹¨

        let cleanText = text.replace(/,/g, "").trim().toUpperCase();
        if (!cleanText) return;

        // ìˆ«ìë§Œ ì…ë ¥ ì‹œ HL ë¶™ì´ê¸°
        if (/^\d+$/.test(cleanText)) {
            cleanText = "HL" + cleanText;
        }

        // 1. í´ë¼ì´ì–¸íŠ¸ë‹¨ ì¤‘ë³µ ì²´í¬
        if (gibunList.includes(cleanText)) {
            gibunInput.value = ""; // ì´ë¯¸ ìˆìœ¼ë©´ ì…ë ¥ì°½ë§Œ ë¹„ì›€
            // í•„ìš” ì‹œ: alert("ì´ë¯¸ ì…ë ¥ëœ ê¸°ë²ˆì…ë‹ˆë‹¤.");
            return;
        }

        // 2. ì„œë²„ ê²€ì¦ ì‹œì‘ (Lock)
        isProcessing = true;
        gibunInput.disabled = true; // ì…ë ¥ì°½ ì ê¸ˆ

        try {
            const response = await fetch(`${CHECK_GIBUN_URL}?gibun=${cleanText}`);
            const data = await response.json();

            if (data.exists) {
                // A. ë“±ë¡ëœ ê¸°ë²ˆ -> ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                if (!gibunList.includes(cleanText)) {
                    // ì´ì¤‘ ì²´í¬
                    gibunList.push(cleanText);
                    updateRealField();
                    renderTags();
                }

                if (gibunWarning) gibunWarning.style.display = "none";
                gibunInput.value = ""; // ì„±ê³µ ì‹œ ì…ë ¥ì°½ ë¹„ìš°ê¸°
            } else {
                // B. ë“±ë¡ë˜ì§€ ì•ŠìŒ -> ê²½ê³ 
                if (gibunWarning) {
                    gibunWarning.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill"></i> '${cleanText}'ëŠ” ë“±ë¡ë˜ì§€ ì•Šì€ ê¸°ë²ˆì…ë‹ˆë‹¤. 
                        í™ˆí˜ì´ì§€ì—ì„œ ë°ì´í„° ë“±ë¡ í™•ì¸í•´ì£¼ì„¸ìš”.
                    `;
                    gibunWarning.style.display = "block";
                    setTimeout(() => {
                        gibunWarning.style.display = "none";
                    }, 3000);
                }
                gibunInput.focus();
            }
        } catch (error) {
            console.error("ê²€ì¦ ì‹¤íŒ¨:", error);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            // 3. ì²˜ë¦¬ ì™„ë£Œ (Unlock)
            isProcessing = false;
            gibunInput.disabled = false;
            gibunInput.focus(); // ë‹¤ì‹œ ì…ë ¥í•  ìˆ˜ ìˆê²Œ í¬ì»¤ìŠ¤
        }
    }

    function removeGibun(index) {
        gibunList.splice(index, 1);
        updateRealField();
        renderTags();
    }

    function renderTags() {
        // ê¸°ì¡´ ë°°ì§€ ì‚­ì œ (ì…ë ¥ì°½ì¸ gibunInputì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
        const currentTags = gibunContainer.querySelectorAll(".badge");
        currentTags.forEach((tag) => tag.remove());

        // ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        gibunList.forEach((gibun, index) => {
            const badge = document.createElement("span");
            badge.className =
                "badge bg-primary d-flex align-items-center me-1 mb-1";
            badge.style.fontSize = "0.9rem";
            badge.style.padding = "8px 12px";
            badge.innerHTML = `
                ${gibun}
                <i class="bi bi-x ms-2" style="cursor: pointer;" onclick="removeGibun(${index})"></i>
            `;
            // ì…ë ¥ì°½ ì•ì— íƒœê·¸ ì‚½ì…
            gibunContainer.insertBefore(badge, gibunInput);
        });
    }

    function updateRealField() {
        realGibunField.value = gibunList.join(",");
        checkFormValidity();
    }

    // ----------------------------------------------------------------
    // 3. í¼ ìœ íš¨ì„± ê²€ì‚¬ (ê¸°ì¡´ê³¼ ë™ì¼)
    // ----------------------------------------------------------------
    function checkFormValidity() {
        const sessionInput = document.querySelector(
            'input[name="session_name"]',
        );
        const sessionVal = sessionInput
            ? sessionInput.value.trim()
            : "";
        const gibunFilled = gibunList.length > 0;

        const submitBtn = document.getElementById("submitBtn");
        const req = document.getElementById("form_requirements");

        let missing = [];
        if (!sessionVal) missing.push("ì„¸ì…˜ ì´ë¦„");
        if (!gibunFilled) missing.push("ê¸°ë²ˆ ì…ë ¥");

        if (sessionVal && gibunFilled) {
            submitBtn.disabled = false;
            if (req) {
                req.innerText = "";
                req.classList.remove("text-danger");
            }
        } else {
            submitBtn.disabled = true;
            if (req) {
                req.innerText =
                    "í•„ìˆ˜: " + missing.join(" Â· ") + " ì…ë ¥ í•„ìš”";
                req.classList.add("text-danger");
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const sessionInput = document.querySelector(
            'input[name="session_name"]',
        );
        if (sessionInput) {
            sessionInput.addEventListener("input", checkFormValidity);
        }
        checkFormValidity();
    });


    </script> {% endcomment %}
    <script>
        const CHECK_GIBUN_URL = "{% url 'check_gibun' %}";
    </script>
    <script defer src="{% static 'js/create_session.js' %}"></script>
{% endblock js %}


{% block main %}
    <div class="container mt-4 mb-3" style="max-width: 800px">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'index' %}" class="btn btn-secondary">
                    <i class="bi bi-house-fill"></i> í™ˆìœ¼ë¡œ
                </a>

                <a
                    href="{% url 'history' %}"
                    class="btn btn-outline-secondary fw-bold"
                >
                    ğŸ“œ ì§€ë‚œ ê¸°ë¡ ë³´ê¸°
                </a>
            </div>
        </div>

        <div class="container" style="max-width: 800px">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">âœˆï¸ ì˜¤ëŠ˜ì˜ ì‘ì—… ì‹œì‘í•˜ê¸°</h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label class="form-label fw-bold">1ï¸âƒ£ì„¸ì…˜ ì´ë¦„</label>
                            <input
                                type="text"
                                name="session_name"
                                class="form-control"
                                value="{{ slot }}"
                                required
                            />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">2ï¸âƒ£ê·¼ë¬´ í˜•íƒœ</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="shift_type"
                                        id="shiftDay"
                                        value="DAY"
                                        {% if session.shift_type == "DAY" %}checked{% endif %} />
                                    <label
                                        class="form-check-label"
                                        for="shiftDay"
                                    >
                                        â˜€ï¸ ì£¼ê°„ (08:00 ~ 20:00)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="shift_type"
                                        id="shiftNight"
                                        value="NIGHT"
                                        {% if session.shift_type == "NIGHT" %}checked{% endif %} />
                                    <label
                                        class="form-check-label"
                                        for="shiftNight"
                                    >
                                        ğŸŒ™ ì•¼ê°„ (20:00 ~ ìµì¼ 08:00)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            {% comment %} <label class="form-label fw-bold"
                                >3ï¸âƒ£ ì„¸ì…˜ ì„ íƒ (ì˜¤ëŠ˜ ì‚¬ìš©í•  ì‘ì—… ê³µê°„)
                            </label>

                            <input
                                type="hidden"
                                name="session_label"
                                id="selected_session"
                                required
                            /> {% endcomment %}

                            <div id="session_button_row" class="row g-2">
                                {% for slot in slots %}
                                <div class="col-6 col-md-3">
                                    <button
                                        type="button"
                                        class="btn w-100 py-3 fw-bold session-btn {% if slot.is_taken %}btn-secondary disabled{% else %}btn-outline-primary{% endif %}"
                                        onclick="selectSession('{{ slot.name }}', this)"
                                        {% if slot.is_taken %}disabled{% endif %}
                                    >
                                        {{ slot.name }} {% if slot.is_taken %}
                                        <br /><span class="badge bg-dark small"
                                            >ì‚¬ìš© ì¤‘</span
                                        >
                                        {% else %}
                                        <br /><span
                                            class="badge bg-success small"
                                            >ê°€ëŠ¥</span
                                        >
                                        {% endif %}
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            {% comment %} <div
                                class="form-text mt-2 d-flex align-items-center"
                                id="selection_msg_wrap"
                            >
                                <div id="selection_msg">
                                    ì‘ì—…í•  ì„¸ì…˜ì„ í´ë¦­í•˜ì„¸ìš”.
                                </div>
                            </div> {% endcomment %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold"
                                    >3ï¸âƒ£ì‘ì—…ì ëª…ë‹¨</label
                                >
                                <textarea
                                    name="worker_names"
                                    class="form-control"
                                    rows="5"
                                    placeholder="ê¹€ì² ìˆ˜, ì´ì˜í¬ (ì—”í„°ë¡œ êµ¬ë¶„)"
                                    required
                                ></textarea>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold"
                                    >3ï¸âƒ£ í•­ê³µê¸° ê¸°ë²ˆ</label
                                >
                                <div
                                    id="gibunContainer"
                                    class="form-control d-flex flex-wrap gap-2 align-items-center"
                                    style="min-height: 45px; cursor: text"
                                >
                                    <input
                                        type="text"
                                        id="gibunInput"
                                        style="
                                            border: none;
                                            outline: none;
                                            background: transparent;
                                            min-width: 100px;
                                            flex-grow: 1;
                                        "
                                        placeholder="ê¸°ë²ˆ ì…ë ¥ í›„ ì—”í„° (ì˜ˆ: HL7777)"
                                    />
                                </div>
                                <div class="form-text">
                                    ì—¬ëŸ¬ ëŒ€ì¼ ê²½ìš° ì—”í„°(Enter) ë˜ëŠ” ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ
                                    êµ¬ë¶„í•˜ì„¸ìš”.
                                </div>

                                <div
                                    id="gibunWarning"
                                    class="alert alert-warning mt-2 py-2 px-3"
                                    style="display: none"
                                >
                                    <i class="bi bi-exclamation-triangle"></i>
                                    ë“±ë¡ë˜ì§€ ì•Šì€ ê¸°ë²ˆì…ë‹ˆë‹¤.
                                </div>

                                <input
                                    type="hidden"
                                    name="gibun_input"
                                    id="realGibunField"
                                />
                            </div>
                        </div>

                        <div class="d-flex gap-2 align-items-center mt-3">
                            <div
                                id="form_requirements"
                                class="form-text text-danger me-2"
                                style="min-width: 200px"
                            >
                                ìš”ê±´ì„ ëª¨ë‘ ì±„ì›Œì•¼ ì‹œì‘ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
                            </div>

                            <button
                                type="submit"
                                class="btn btn-success flex-fill py-3 fw-bold fs-5"
                                id="submitBtn"
                                disabled
                            >
                                ğŸš€ ì‘ì—… ì‹œì‘í•˜ê¸°
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock main %}

