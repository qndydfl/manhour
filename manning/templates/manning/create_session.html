<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ì‘ì—… ì„¸ì…˜ ì‹œì‘</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        />
        <link
            rel="stylesheet"
            as="style"
            crossorigin
            href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
        />
        <style>
            body {
                font-family: "Pretendard", sans-serif;
            }
        </style>
    </head>
    <body class="bg-light">
        <div class="text-end mb-3">
            <a
                href="{% url 'history' %}"
                class="btn btn-link text-decoration-none fw-bold"
            >
                ğŸ“œ ì§€ë‚œ ê¸°ë¡ ë³´ê¸°
            </a>
        </div>

        <div class="container mt-5" style="max-width: 800px">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">âœˆï¸ ì˜¤ëŠ˜ì˜ ì‘ì—… ì‹œì‘í•˜ê¸°</h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}

                        <div class="mb-4">
                            <label class="form-label fw-bold"
                                >1ï¸âƒ£ ì„¸ì…˜ ì„ íƒ (ì˜¤ëŠ˜ ì‚¬ìš©í•  ì‘ì—… ê³µê°„)
                            </label>

                            <input
                                type="hidden"
                                name="session_name"
                                id="selected_session"
                                required
                            />

                            <div id="session_button_row" class="row g-2">
                                {% for slot in slots %}
                                <div class="col-6 col-md-3">
                                    <button
                                        type="button"
                                        class="btn w-100 py-3 fw-bold session-btn {% if slot.is_taken %}btn-secondary disabled{% else %}btn-outline-primary{% endif %}"
                                        onclick="selectSession('{{ slot.name }}', this)"
                                        {%
                                        if
                                        slot.is_taken
                                        %}disabled{%
                                        endif
                                        %}
                                    >
                                        {{ slot.name }} {% if slot.is_taken %}
                                        <br /><span class="badge bg-dark small"
                                            >ì‚¬ìš© ì¤‘</span
                                        >
                                        {% else %}
                                        <br /><span
                                            class="badge bg-success small"
                                            >ê°€ëŠ¥</span
                                        >
                                        {% endif %}
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            <div
                                class="form-text mt-2 d-flex align-items-center"
                                id="selection_msg_wrap"
                            >
                                <div id="selection_msg">
                                    ì‘ì—…í•  ì„¸ì…˜ì„ í´ë¦­í•˜ì„¸ìš”.
                                </div>
                                <!-- ì„ íƒëœ ì„¸ì…˜ì€ ë©”ì‹œì§€ ì˜ì—­ì—ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤ (ë³„ë„ ìš”ì†Œ ì œê±°) -->
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold"
                                    >2ï¸âƒ£ ì‘ì—…ì ëª…ë‹¨</label
                                >
                                <textarea
                                    name="worker_names"
                                    class="form-control"
                                    rows="5"
                                    placeholder="ê¹€ì² ìˆ˜, ì´ì˜í¬ (ì—”í„°ë¡œ êµ¬ë¶„)"
                                    required
                                ></textarea>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold"
                                    >3ï¸âƒ£ í•­ê³µê¸° ê¸°ë²ˆ</label
                                >
                                <div
                                    id="gibunContainer"
                                    class="form-control d-flex flex-wrap gap-2 align-items-center"
                                    style="min-height: 45px; cursor: text"
                                >
                                    <input
                                        type="text"
                                        id="gibunInput"
                                        style="
                                            border: none;
                                            outline: none;
                                            background: transparent;
                                            min-width: 100px;
                                            flex-grow: 1;
                                        "
                                        placeholder="ê¸°ë²ˆ ì…ë ¥ í›„ ì—”í„° (ì˜ˆ: HL7777)"
                                    />
                                </div>
                                <div class="form-text">
                                    ì—¬ëŸ¬ ëŒ€ì¼ ê²½ìš° ì—”í„°(Enter) ë˜ëŠ” ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ
                                    êµ¬ë¶„í•˜ì„¸ìš”.
                                </div>

                                <input
                                    type="hidden"
                                    name="gibun_input"
                                    id="realGibunField"
                                />
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <div
                                id="form_requirements"
                                class="form-text text-danger me-2"
                                style="min-width: 280px"
                            >
                                ìš”ê±´ì„ ëª¨ë‘ ì±„ì›Œì•¼ 'ì‘ì—… ì‹œì‘í•˜ê¸°'ê°€
                                í™œì„±í™”ë©ë‹ˆë‹¤.
                            </div>
                            <button
                                type="submit"
                                class="btn btn-success flex-fill py-3 fw-bold fs-5"
                                id="submitBtn"
                                disabled
                            >
                                ğŸš€ ì‘ì—… ì‹œì‘í•˜ê¸°
                            </button>
                            <button
                                type="button"
                                id="cancelBtn"
                                class="btn btn-outline-secondary py-3 fw-bold"
                                onclick="resetForm()"
                            >
                                âŒ ì·¨ì†Œ
                            </button>
                            <a
                                href="{% url 'home' %}"
                                class="btn btn-light py-3 fw-bold"
                                >ğŸ  í™ˆìœ¼ë¡œ ì´ë™</a
                            >
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            function selectSession(name, btnElement) {
                // 1. ìˆ¨ê²¨ì§„ ì¹¸ì— ì´ë¦„ ë„£ê¸°
                document.getElementById("selected_session").value = name;

                // 2. ëª¨ë“  ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                document.querySelectorAll(".session-btn").forEach((btn) => {
                    if (!btn.disabled) {
                        btn.classList.remove("btn-primary", "text-white");
                        btn.classList.add("btn-outline-primary");
                    }
                });

                // 3. ì„ íƒí•œ ë²„íŠ¼ë§Œ ìƒ‰ì¹ í•˜ê¸°
                btnElement.classList.remove("btn-outline-primary");
                btnElement.classList.add("btn-primary", "text-white");

                // 4. ë©”ì‹œì§€ ë° ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
                document.getElementById("selection_msg").innerText =
                    "âœ… ì„ íƒë¨: " + name;
                document
                    .getElementById("selection_msg")
                    .classList.add("text-primary", "fw-bold");
                document.getElementById("submitBtn").disabled = false;
                checkFormValidity();
            }

            const gibunContainer = document.getElementById("gibunContainer");
            const gibunInput = document.getElementById("gibunInput");
            const realGibunField = document.getElementById("realGibunField");

            let gibunList = []; // ê¸°ë²ˆë“¤ì„ ë‹´ì„ ë°°ì—´

            // 1. ì»¨í…Œì´ë„ˆ ì•„ë¬´ë°ë‚˜ í´ë¦­í•´ë„ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            gibunContainer.addEventListener("click", () => gibunInput.focus());

            // 2. í‚¤ ì…ë ¥ ê°ì§€ (ì—”í„°, ìŠ¤í˜ì´ìŠ¤, ì‰¼í‘œ)
            gibunInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter" || e.key === "," || e.key === " ") {
                    e.preventDefault(); // í¼ ì „ì†¡ ë§‰ê¸°
                    addGibun(this.value);
                    this.value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                }
                // ë°±ìŠ¤í˜ì´ìŠ¤ë¡œ ë§ˆì§€ë§‰ íƒœê·¸ ì‚­ì œ
                if (
                    e.key === "Backspace" &&
                    this.value === "" &&
                    gibunList.length > 0
                ) {
                    removeGibun(gibunList.length - 1);
                }
            });

            // 3. ê¸°ë²ˆ ì¶”ê°€ í•¨ìˆ˜ (ì •ê·œí™” í¬í•¨)
            function addGibun(text) {
                let cleanText = text.trim().toUpperCase();
                if (!cleanText) return;

                // ìˆ«ìë§Œ ìˆìœ¼ë©´ ì•ì— HL ë¶™ì´ê¸°
                if (/^\d+$/.test(cleanText)) {
                    cleanText = "HL" + cleanText;
                }

                // ì¤‘ë³µ ì²´í¬
                if (gibunList.includes(cleanText)) {
                    // Optional: show a message to the user
                    return;
                }

                gibunList.push(cleanText);
                updateRealField();
                renderTags();
                checkFormValidity();
            }

            // 4. ê¸°ë²ˆ ì‚­ì œ í•¨ìˆ˜
            function removeGibun(index) {
                gibunList.splice(index, 1);
                updateRealField();
                renderTags();
                checkFormValidity();
            }

            // 5. í™”ë©´ ê·¸ë¦¬ê¸° (íƒœê·¸ ë Œë”ë§)
            function renderTags() {
                // ê¸°ì¡´ íƒœê·¸ë“¤ ì§€ìš°ê³  (inputì€ ë‚¨ê¹€)
                const currentTags = gibunContainer.querySelectorAll(".badge");
                currentTags.forEach((tag) => tag.remove());

                // ë°°ì—´ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ì‹œ ê·¸ë¦¼
                gibunList.forEach((gibun, index) => {
                    const badge = document.createElement("span");
                    badge.className =
                        "badge bg-primary d-flex align-items-center";
                    badge.style.fontSize = "0.9rem";
                    badge.style.padding = "8px 12px";
                    badge.innerHTML = `
                    ${gibun}
                    <i class="bi bi-x ms-2" style="cursor: pointer;" onclick="removeGibun(${index})"></i>
                `;
                    // input ì•ì— ì‚½ì…
                    gibunContainer.insertBefore(badge, gibunInput);
                });
            }

            // 6. ìˆ¨ê²¨ì§„ inputì— ê°’ ì—…ë°ì´íŠ¸ (ì„œë²„ ì „ì†¡ìš©)
            function updateRealField() {
                // ë°°ì—´ì„ ì½¤ë§ˆ(,)ë¡œ ì—°ê²°í•´ì„œ ë¬¸ìì—´ë¡œ ë§Œë“¦
                realGibunField.value = gibunList.join(",");
                checkFormValidity();
            }

            // 7. í¼ ë¦¬ì…‹/ì·¨ì†Œ ì²˜ë¦¬
            function resetForm() {
                // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                document.getElementById("selected_session").value = "";
                document.getElementById("selection_msg").innerText =
                    "ì‘ì—…í•  ì„¸ì…˜ì„ í´ë¦­í•˜ì„¸ìš”.";
                document
                    .getElementById("selection_msg")
                    .classList.remove("text-primary", "fw-bold");
                document.getElementById("submitBtn").disabled = true;

                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì›ë³µ
                document.querySelectorAll(".session-btn").forEach((btn) => {
                    if (!btn.disabled) {
                        btn.classList.remove("btn-primary", "text-white");
                        btn.classList.add("btn-outline-primary");
                    }
                });

                // ì‘ì—…ì ëª©ë¡ ë° ê¸°ë²ˆ ì´ˆê¸°í™”
                const workerArea = document.querySelector(
                    'textarea[name="worker_names"]'
                );
                if (workerArea) workerArea.value = "";
                gibunList = [];
                renderTags();
                updateRealField();
                checkFormValidity();
            }

            // 8. í¼ ìœ íš¨ì„± ê²€ì‚¬: ì„¸ì…˜ ì„ íƒ, ì‘ì—…ì ëª…ë‹¨, ê¸°ë²ˆ ì…ë ¥ì´ ëª¨ë‘ ìˆìœ¼ë©´ ì œì¶œ ë²„íŠ¼ í™œì„±í™”
            function checkFormValidity() {
                const sessionSelected =
                    document.getElementById("selected_session").value.trim() !==
                    "";
                const workerArea = document.querySelector(
                    'textarea[name="worker_names"]'
                );
                const workersFilled =
                    workerArea && workerArea.value.trim() !== "";
                const gibunFilled = gibunList.length > 0;

                const submitBtn = document.getElementById("submitBtn");
                const req = document.getElementById("form_requirements");
                let missing = [];
                if (!sessionSelected) missing.push("ì„¸ì…˜ ì„ íƒ");
                if (!workersFilled) missing.push("ì‘ì—…ì ëª…ë‹¨");
                if (!gibunFilled) missing.push("ê¸°ë²ˆ ì…ë ¥");

                if (missing.length === 0) {
                    submitBtn.disabled = false;
                    if (req) {
                        req.innerText = "";
                        req.classList.remove("text-danger");
                    }
                } else {
                    submitBtn.disabled = true;
                    if (req) {
                        req.innerText =
                            "í•„ìˆ˜: " + missing.join(" Â· ") + " ì…ë ¥ í•„ìš”";
                        req.classList.add("text-danger");
                    }
                }
            }

            // 9. í˜ì´ì§€ ë¡œë“œ ì‹œ URL ì¿¼ë¦¬ì—ì„œ slot íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ìë™ ì„ íƒ
            document.addEventListener("DOMContentLoaded", function () {
                // pre-check validity
                checkFormValidity();

                // worker textarea input should update validity dynamically
                const workerArea = document.querySelector(
                    'textarea[name="worker_names"]'
                );
                if (workerArea) {
                    workerArea.addEventListener("input", checkFormValidity);
                }

                // also watch gibun input's blur to update (in case user pastes and tabs out)
                if (gibunInput) {
                    gibunInput.addEventListener("blur", function () {
                        const v = this.value.trim();
                        if (v) {
                            addGibun(v);
                            this.value = "";
                        }
                        checkFormValidity();
                    });
                }

                const params = new URLSearchParams(window.location.search);
                const slot = params.get("slot");
                if (slot) {
                    // find session button matching slot name
                    const buttons = document.querySelectorAll(".session-btn");
                    let found = false;
                    for (const btn of buttons) {
                        // Check onclick attribute or text content
                        const onclick = btn.getAttribute("onclick") || "";
                        if (
                            onclick.includes("'" + slot + "'") ||
                            btn.textContent.trim().startsWith(slot)
                        ) {
                            if (!btn.disabled) {
                                // call selectSession with the element
                                selectSession(slot, btn);
                                // make session read-only: hide the buttons and show plain text
                                const row =
                                    document.getElementById(
                                        "session_button_row"
                                    );
                                const selectionMsg =
                                    document.getElementById("selection_msg");
                                if (row && selectionMsg) {
                                    row.style.display = "none";
                                    selectionMsg.innerText =
                                        "âœ… ì„ íƒë¨: " + slot;
                                    selectionMsg.classList.add(
                                        "text-primary",
                                        "fw-bold"
                                    );
                                }
                                found = true;
                            }
                            break;
                        }
                    }
                    // Fallback: if no matching button found, still set hidden field and show read-only
                    if (!found) {
                        const row =
                            document.getElementById("session_button_row");
                        const selectionMsg =
                            document.getElementById("selection_msg");
                        const hidden =
                            document.getElementById("selected_session");
                        if (hidden) hidden.value = slot;
                        if (row && selectionMsg) {
                            row.style.display = "none";
                            selectionMsg.innerText = "âœ… ì„ íƒë¨: " + slot;
                            selectionMsg.classList.add(
                                "text-primary",
                                "fw-bold"
                            );
                        }
                        checkFormValidity();
                    }
                }
            });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
