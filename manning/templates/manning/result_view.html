{% extends "manning/base/base.html" %}
{% load static %}

<title>{% block title %}ë°°ì • ê²°ê³¼{% endblock title %}</title>

{% block style %}
<style>
    body {
        font-family: "Pretendard", sans-serif;
    }
    .res-direct {
        background-color: #f0fff4 !important;
        color: #006400;
    }
    .res-indirect {
        background-color: #fff5f5 !important;
        color: #c53030;
    }
</style>
{% endblock style %}

{% block main %}
    <div class="container p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a
                    href="{% url 'index' %}"
                    class="btn btn-outline-secondary btn-sm"
                >
                    <i class="bi bi-house-door-fill"></i> í™ˆ
                </a>
                <h2 class="mb-0 fw-bold">ğŸ“Š {{ session.name }} ê²°ê³¼</h2>
            </div>
            <div class="d-flex gap-2">
                <a
                    href="{% url 'edit_session' session.id %}"
                    class="btn btn-outline-dark btn-sm d-flex align-items-center"
                >
                    ğŸ”§ ëª…ë‹¨/ì´ë¦„ ë³€ê²½
                </a>

                <a
                    href="{% url 'manage_items' session.id %}"
                    class="btn btn-primary btn-sm fw-bold d-flex align-items-center"
                >
                    âš™ï¸ í†µí•© ê´€ë¦¬ (ì¼ê°/í•œë„)
                </a>
                <button
                    type="button"
                    class="btn btn-success btn-sm fw-bold d-flex align-items-center"
                    data-bs-toggle="modal"
                    data-bs-target="#uploadModal"
                >
                    ğŸ“¥ ì—‘ì…€ ë“±ë¡
                </button>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mb-3">
            <form
                action="{% url 'trigger_auto_assign' session.id %}"
                method="POST"
                class="d-inline"
            >
                {% csrf_token %}
                <button
                    type="submit"
                    class="btn btn-warning fw-bold shadow-sm"
                >
                    <i class="bi bi-magic"></i> ìë™ ë°°ì • ì‹¤í–‰í•˜ê¸°
                </button>
            </form>

            <form
                id="finish-form"
                action="{% url 'finish_session' session.id %}"
                method="POST"
            >
                {% csrf_token %}
                <button
                    type="submit"
                    class="btn btn-success fw-bold px-4"
                    onclick="
                        return confirm(
                            'ì •ë§ ì‘ì—…ì„ ì™„ë£Œí•˜ê³  ê¸°ë¡ ë³´ê´€ì†Œë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                        );
                    "
                >
                    âœ… ì‘ì—… ì™„ë£Œ (í‡´ì‹¤)
                </button>
            </form>
        </div>

        {% comment %} {% if messages %} {% for message in messages %}
        <div
            class="alert alert-success alert-dismissible fade show"
            role="alert"
        >
            {{ message }}
            <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
            ></button>
        </div>
        {% endfor %} {% endif %} {% endcomment %}

        <div class="card shadow-sm border-secondary mb-5">
            <div
                class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"
            >
                <h5 class="mb-0">
                    <i class="bi bi-person-gear me-2"></i>ì‘ì—…ì í˜„í™©
                </h5>
                <small>ìµœëŒ€ ê·¼ë¬´ ì‹œê°„ì„ ìˆ˜ì • í›„ [ì €ì¥]ì„ ëˆ„ë¥´ì„¸ìš”.</small>
            </div>

            <div class="card-body bg-light">
                <form
                    action="{% url 'update_limits' session.id %}"
                    method="POST"
                >
                    {% csrf_token %}
                    <div class="row g-3">
                        {% for worker in workers %}
                        <div class="col-6 col-md-4 col-lg-2">
                            <div
                                class="card h-100 text-center {% if worker.used_mh > worker.limit_mh %}border-danger{% endif %}"
                            >
                                <div class="card-body p-2">
                                    <div class="fw-bold mb-1 text-truncate">
                                        {{ worker.name }}
                                    </div>
                                    <div class="h3 mb-2 text-primary">
                                        {{ worker.used_mh|floatformat:2 }}
                                    </div>
                                    <div
                                        class="d-flex align-items-center justify-content-center gap-1 text-muted small"
                                    >
                                        <span>/ Max</span>
                                        <input
                                            type="number"
                                            step="0.5"
                                            name="limit_{{ worker.id }}"
                                            class="form-control form-control-sm text-center fw-bold p-0"
                                            style="
                                                width: 50px;
                                                height: 24px;
                                            "
                                            value="{{ worker.limit_mh }}"
                                        />
                                    </div>
                                </div>
                                {% widthratio worker.used_mh worker.limit_mh 100 as ratio %}
                                <div class="progress" style="height: 4px">
                                    <div
                                        class="progress-bar {% if worker.used_mh > worker.limit_mh %}bg-danger{% else %}bg-success{% endif %}"
                                        role="progressbar"
                                        style="width: {{ ratio }}%;"
                                    ></div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3 text-end">
                        <button
                            type="submit"
                            class="btn btn-dark btn-sm fw-bold"
                        >
                            ğŸ’¾ í•œë„(Max Time) ì €ì¥í•˜ê¸°
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="mb-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ“‹ ì‘ì—… ë‚´ì—­</h5>
            <div class="d-flex gap-2">
                <a
                    href="{% url 'assigned_summary' session.id %}"
                    class="btn btn-info btn-sm"
                >
                    ğŸ“… ì‘ì—… ì‹œê°„ë³„ ë³´ê¸°
                </a>
            </div>
        </div>

        <div class="card shadow-sm mb-5">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table
                        class="table table-bordered table-hover mb-0 text-center align-middle"
                    >
                        <thead class="table-dark">
                            <tr>
                                <th>ê¸°ë²ˆ</th>
                                <th>WO</th>
                                <th>OP</th>
                                <th>ì„¤ëª…</th>
                                <th>ì´ ì‹œê°„</th>
                                <th style="width: 40%">
                                    ë°°ì • ê²°ê³¼ (ì´ë¦„ : ì‹œê°„)
                                </th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %} {% if item.work_order != 'ê°„ë¹„' %}
                            <tr
                                {%
                                if
                                item.is_manual
                                %}class="table-info"
                                {%
                                endif
                                %}
                            >
                                <td class="fw-bold">
                                    {{ item.gibun_input }}
                                </td>

                                <td>{{ item.work_order }}</td>
                                <td>{{ item.op }}</td>
                                <td class="text-start">
                                    {{ item.description }}
                                </td>
                                <td class="fw-bold text-primary">
                                    {{ item.work_mh }}
                                </td>
                                <td class="text-start">
                                    {% for assign in item.assignments.all %}
                                    <span class="badge bg-secondary me-1">
                                        {{ assign.worker.name }} ({{ assign.allocated_mh|floatformat:2 }})
                                    </span>
                                    {% empty %}
                                    <span class="text-muted small"
                                        >ì•„ì§ ë°°ì • ì•ˆë¨</span
                                    >
                                    {% endfor %}
                                </td>
                                <td>
                                    <a
                                        href="{% url 'edit_item' item.id %}"
                                        class="btn btn-sm btn-outline-secondary"
                                    >
                                        âœï¸ ìˆ˜ì •
                                    </a>
                                </td>
                            </tr>
                            {% endif %} 
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div
        class="modal fade"
        id="uploadModal"
        tabindex="-1"
        aria-labelledby="uploadModalLabel"
        aria-hidden="true"
    >
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold" id="uploadModalLabel">
                        ğŸ“Š ì—‘ì…€ ë°ì´í„° ì¼ê´„ ë“±ë¡
                    </h5>
                    <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <form
                        method="POST"
                        action="{% url 'upload_data' session.id %}"
                        enctype="multipart/form-data"
                    >
                        {% csrf_token %}

                        <div class="mb-3">
                            <label
                                for="excelFile"
                                class="form-label fw-bold"
                                >íŒŒì¼ ì„ íƒ (.xlsx, .xls)</label
                            >
                            <input
                                type="file"
                                class="form-control"
                                id="excelFile"
                                name="file"
                                accept=".xlsx, .xls"
                                required
                            />
                        </div>

                        <div class="alert alert-light border small">
                            <strong
                                >â€» ì—‘ì…€ ì»¬ëŸ¼ ìˆœì„œ (ì²« ì¤„ í—¤ë” í¬í•¨):</strong
                            ><br />
                            <span class="badge bg-secondary">ê¸°ì¢…</span>
                            <span class="badge bg-secondary">WO</span>
                            <span class="badge bg-secondary">OP</span>
                            <span class="badge bg-secondary">ì„¤ëª…</span>
                            <span class="badge bg-secondary">M/H</span>
                        </div>

                        <div class="d-grid">
                            <button
                                type="submit"
                                class="btn btn-success fw-bold"
                            >
                                ğŸš€ ë°ì´í„° ì—…ë¡œë“œ ë° ì €ì¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock main %}

