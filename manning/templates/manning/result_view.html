<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ë°°ì • ê²°ê³¼</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        />
        <link
            rel="stylesheet"
            as="style"
            crossorigin
            href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
        />
        <style>
            body {
                font-family: "Pretendard", sans-serif;
            }

            #modalInputGrid input {
                width: 100%;
                border: none;
                background: transparent;
                text-align: center;
                outline: none;
                padding: 5px;
            }
            #modalInputGrid input:focus {
                background-color: #e8f0fe; /* í¬ì»¤ìŠ¤ ì‹œ ì—°í•œ íŒŒë‘ */
                font-weight: bold;
            }

            /* ê²°ê³¼ í…Œì´ë¸” ìƒ‰ìƒ */
            .res-direct {
                background-color: #f0fff4 !important;
                color: #006400;
            } /* ì§ë¹„: ì—°ë‘ */
            .res-indirect {
                background-color: #fff5f5 !important;
                color: #c53030;
            } /* ê°„ë¹„: ì—°í•œ ë¹¨ê°• */
        </style>
    </head>
    <body class="p-4 bg-light">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center gap-3">
                    <a
                        href="{% url 'index' %}"
                        class="btn btn-outline-secondary btn-sm"
                    >
                        <i class="bi bi-house-door-fill"></i> í™ˆ
                    </a>
                    <h2 class="mb-0 fw-bold">ğŸ“Š {{ session.name }} ê²°ê³¼</h2>
                </div>

                <div class="d-flex gap-2">
                    <a
                        href="{% url 'edit_session' session.id %}"
                        class="btn btn-outline-dark btn-sm d-flex align-items-center"
                    >
                        ğŸ”§ ëª…ë‹¨/ì´ë¦„ ë³€ê²½
                    </a>

                    <a
                        href="{% url 'manage_items' session.id %}"
                        class="btn btn-primary btn-sm fw-bold d-flex align-items-center"
                    >
                        âš™ï¸ í†µí•© ê´€ë¦¬ (ì¼ê°/í•œë„)
                    </a>
                    <button
                        type="button"
                        class="btn btn-success btn-sm fw-bold d-flex align-items-center"
                        data-bs-toggle="modal"
                        data-bs-target="#uploadModal"
                    >
                        ğŸ“¥ ì—‘ì…€ ë“±ë¡
                    </button>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mb-3">
                <form method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary fw-bold px-4">
                        âš¡ ìë™ ë°°ì • ì‹¤í–‰í•˜ê¸°
                    </button>
                </form>

                <form
                    id="finish-form"
                    action="{% url 'finish_session' session.id %}"
                    method="POST"
                >
                    {% csrf_token %}
                    <button
                        type="button"
                        class="btn btn-success fw-bold px-4"
                        data-bs-toggle="modal"
                        data-bs-target="#finishModal"
                    >
                        âœ… ì‘ì—… ì™„ë£Œ (í‡´ì‹¤)
                    </button>
                </form>
            </div>

            {% if messages %} {% for message in messages %}
            <div
                class="alert alert-success alert-dismissible fade show"
                role="alert"
            >
                {{ message }}
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="alert"
                ></button>
            </div>
            {% endfor %} {% endif %}

            <div class="card shadow-sm border-secondary mb-5">
                <div
                    class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"
                >
                    <h5 class="mb-0">
                        <i class="bi bi-person-gear me-2"></i>ì‘ì—…ì í˜„í™©
                    </h5>
                    <small
                        >ìµœëŒ€ ê·¼ë¬´ ì‹œê°„ì„ ìˆ˜ì • í›„ [ì €ì¥]ì„
                        ëˆ„ë¥´ì„¸ìš”.</small
                    >
                </div>

                <div class="card-body bg-light">
                    <form
                        action="{% url 'update_limits' session.id %}"
                        method="POST"
                    >
                        {% csrf_token %}
                        <div class="row g-3">
                            {% for worker in workers %}
                            <div class="col-6 col-md-4 col-lg-2">
                                <div
                                    class="card h-100 text-center {% if worker.used_mh > worker.limit_mh %}border-danger{% endif %}"
                                >
                                    <div class="card-body p-2">
                                        <div class="fw-bold mb-1 text-truncate">
                                            {{ worker.name }}
                                        </div>
                                        <div class="h3 mb-2 text-primary">
                                            {{ worker.used_mh|floatformat:2 }}
                                        </div>
                                        <div
                                            class="d-flex align-items-center justify-content-center gap-1 text-muted small"
                                        >
                                            <span>/ Max</span>
                                            <input
                                                type="number"
                                                step="0.5"
                                                name="limit_{{ worker.id }}"
                                                class="form-control form-control-sm text-center fw-bold p-0"
                                                style="
                                                    width: 50px;
                                                    height: 24px;
                                                "
                                                value="{{ worker.limit_mh }}"
                                            />
                                        </div>
                                    </div>
                                    {% widthratio worker.used_mh worker.limit_mh 100 as ratio %}
                                    <div class="progress" style="height: 4px">
                                        <div
                                            class="progress-bar {% if worker.used_mh > worker.limit_mh %}bg-danger{% else %}bg-success{% endif %}"
                                            role="progressbar"
                                            style="width: {{ ratio }}%;"
                                        ></div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-3 text-end">
                            <button
                                type="submit"
                                class="btn btn-dark btn-sm fw-bold"
                            >
                                ğŸ’¾ í•œë„(Max Time) ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="mb-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ğŸ“‹ ì‘ì—… ë‚´ì—­</h5>
                <div class="d-flex gap-2">
                    <button
                        type="button"
                        class="btn btn-primary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#timeInputModal"
                    >
                        â±ï¸ ì‘ì—… ì‹œê°„ ì…ë ¥
                    </button>
                    <a
                        href="{% url 'assigned_summary' session.id %}"
                        class="btn btn-info btn-sm"
                    >
                        ğŸ“… ì‘ì—… ì‹œê°„ë³„ ë³´ê¸°
                    </a>
                </div>
            </div>

            <div class="card shadow-sm mb-5">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table
                            class="table table-bordered table-hover mb-0 text-center align-middle"
                        >
                            <thead class="table-dark">
                                <tr>
                                    <th>ê¸°ë²ˆ</th>
                                    <th>WO</th>
                                    <th>OP</th>
                                    <th>ì„¤ëª…</th>
                                    <th>ì´ ì‹œê°„</th>
                                    <th style="width: 40%">
                                        ë°°ì • ê²°ê³¼ (ì´ë¦„ : ì‹œê°„)
                                    </th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %} {% if item.work_order != 'ê°„ë¹„' %}
                                <tr
                                    {% if item.is_manual %}class="table-info"{% endif %}
                                >
                                    <td class="fw-bold">
                                        {{ item.gibun_input }}
                                    </td>

                                    <td>{{ item.work_order }}</td>
                                    <td>{{ item.op }}</td>
                                    <td class="text-start">
                                        {{ item.description }}
                                    </td>
                                    <td class="fw-bold text-primary">
                                        {{ item.work_mh }}
                                    </td>
                                    <td class="text-start">
                                        {% for assign in item.assignments.all %}
                                        <span class="badge bg-secondary me-1">
                                            {{ assign.worker.name }} ({{ assign.allocated_mh|floatformat:2 }})
                                        </span>
                                        {% empty %}
                                        <span class="text-muted small"
                                            >ì•„ì§ ë°°ì • ì•ˆë¨</span
                                        >
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <a
                                            href="{% url 'edit_item' item.id %}"
                                            class="btn btn-sm btn-outline-secondary"
                                        >
                                            âœï¸ ìˆ˜ì •
                                        </a>
                                    </td>
                                </tr>
                                {% endif %} {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div
            class="modal fade"
            id="uploadModal"
            tabindex="-1"
            aria-labelledby="uploadModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title fw-bold" id="uploadModalLabel">
                            ğŸ“Š ì—‘ì…€ ë°ì´í„° ì¼ê´„ ë“±ë¡
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <form
                            method="POST"
                            action="{% url 'upload_data' pk=session.id %}"
                            enctype="multipart/form-data"
                        >
                            {% csrf_token %}

                            <div class="mb-3">
                                <label
                                    for="excelFile"
                                    class="form-label fw-bold"
                                    >íŒŒì¼ ì„ íƒ (.xlsx, .xls)</label
                                >
                                <input
                                    type="file"
                                    class="form-control"
                                    id="excelFile"
                                    name="file"
                                    accept=".xlsx, .xls"
                                    required
                                />
                            </div>

                            <div class="alert alert-light border small">
                                <strong
                                    >â€» ì—‘ì…€ ì»¬ëŸ¼ ìˆœì„œ (ì²« ì¤„ í—¤ë” í¬í•¨):</strong
                                ><br />
                                <span class="badge bg-secondary">ê¸°ì¢…</span>
                                <span class="badge bg-secondary">WO</span>
                                <span class="badge bg-secondary">OP</span>
                                <span class="badge bg-secondary">ì„¤ëª…</span>
                                <span class="badge bg-secondary">M/H</span>
                            </div>

                            <div class="d-grid">
                                <button
                                    type="submit"
                                    class="btn btn-success fw-bold"
                                >
                                    ğŸš€ ë°ì´í„° ì—…ë¡œë“œ ë° ì €ì¥
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div
            class="modal fade"
            id="timeInputModal"
            tabindex="-1"
            aria-labelledby="timeInputModalLabel"
            aria-hidden="true"
            data-bs-backdrop="static"
        >
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5
                            class="modal-title fw-bold"
                            id="timeInputModalLabel"
                        >
                            â±ï¸ ì‘ì—… ì‹œê°„ ì…ë ¥
                        </h5>
                        <button
                            type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <div id="alert-container"></div>

                        <div class="mb-3">
                            <label class="form-label fw-bold"
                                >ì‘ì—…ì ì„ íƒ</label
                            >
                            <select
                                id="worker-select"
                                class="form-select form-select-sm mb-3"
                            >
                                <option value="">
                                    -- ì‘ì—…ìë¥¼ ì„ íƒí•˜ì„¸ìš” --
                                </option>
                                <option value="all">ëª¨ë‘</option>
                                {% for worker in workers %} {% if worker.name != 'ê°„ë¹„' %}
                                <option value="{{ worker.id }}">
                                    {{ worker.name }}
                                </option>
                                {% endif %} {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">ì‹œê°„ ì…ë ¥</label>
                            <table
                                class="table table-bordered text-center align-middle"
                            >
                                <thead class="table-light">
                                    <tr>
                                        <th width="30%">ì‹œì‘ì‹œê°„</th>
                                        <th width="30%">ê°„ë¹„(ì½”ë“œ)</th>
                                        <th width="30%">ì¢…ë£Œì‹œê°„</th>
                                        <th width="10%"></th>
                                    </tr>
                                </thead>
                                <tbody id="time-input-rows">
                                    {% for i in "0123456789" %}
                                    <tr class="time-input-row">
                                        <td>
                                            <input
                                                type="text"
                                                class="form-control form-control-sm start-time"
                                                placeholder="0800"
                                                maxlength="4"
                                            />
                                        </td>
                                        <td>
                                            <input
                                                type="text"
                                                class="form-control form-control-sm code"
                                                placeholder="ì½”ë“œ"
                                            />
                                        </td>
                                        <td>
                                            <input
                                                type="text"
                                                class="form-control form-control-sm end-time"
                                                placeholder="1000"
                                                maxlength="4"
                                            />
                                        </td>
                                        <td>
                                            <button
                                                type="button"
                                                class="btn btn-sm btn-danger delete-row"
                                                onclick="deleteRow(this)"
                                            >
                                                âœ•
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mb-3">
                            <button
                                type="button"
                                class="btn btn-sm btn-outline-secondary"
                                id="add-row-btn"
                            >
                                + í–‰ ì¶”ê°€
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                        >
                            ì·¨ì†Œ
                        </button>
                        <button
                            type="button"
                            class="btn btn-success fw-bold"
                            id="save-times-btn"
                        >
                            ğŸ’¾ ì €ì¥í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div
            class="modal fade"
            id="finishModal"
            tabindex="-1"
            aria-labelledby="finishModalLabel"
            aria-hidden="true"
            data-bs-backdrop="static"
        >
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-sm">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title fw-bold" id="#finishModalLabel">
                            âœ… ì‘ì—… ì™„ë£Œ í™•ì¸
                        </h5>
                        <button
                            type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-2">
                            ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ì‹œê³  <strong>ì™„ë£Œ</strong> ë²„íŠ¼ì„
                            ëˆŒëŸ¬ì£¼ì„¸ìš”.
                        </p>
                        <div class="p-3 rounded bg-light border">
                            <p class="mb-1">
                                <strong>ì„¸ì…˜ëª…:</strong> {{ session.name }}
                            </p>
                            <p class="mb-0 text-muted">
                                ì´ ì„¸ì…˜ì€ ê¸°ë¡ ë³´ê´€ì†Œë¡œ ì´ë™í•˜ë©°, í˜„ì¬ ë°©ì€ ë‹¤ì‹œ
                                ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                        >
                            ì·¨ì†Œ
                        </button>
                        <button
                            type="button"
                            id="confirm-finish-btn"
                            class="btn btn-success fw-bold"
                        >
                            ì‘ì—… ì™„ë£Œë¡œ ê¸°ë¡
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // -----------------------------------------------------------
            // 1. [ì‘ì—… ì™„ë£Œ/í‡´ì‹¤] ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
            // -----------------------------------------------------------
            document.addEventListener("DOMContentLoaded", function () {
                const confirmBtn =
                    document.getElementById("confirm-finish-btn");
                if (confirmBtn) {
                    confirmBtn.addEventListener("click", function () {
                        // [í•µì‹¬] í‡´ì‹¤ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ ì„ì‹œ ì…ë ¥ ë°ì´í„°ë¥¼ ì‹¹ ì§€ì›ë‹ˆë‹¤.
                        try {
                            localStorage.removeItem(
                                `manning_time_input_{{ session.id }}`
                            );
                        } catch (e) {}

                        // í¼ ì œì¶œ (ì„œë²„ë¡œ ì¢…ë£Œ ì‹ í˜¸ ì „ì†¡)
                        const form = document.getElementById("finish-form");
                        if (form) form.submit();
                    });
                }
            });

            // -----------------------------------------------------------
            // 2. [ì‘ì—… ì‹œê°„ ì…ë ¥] ëª¨ë‹¬ ê´€ë ¨ ë¡œì§
            // -----------------------------------------------------------
            const STORAGE_KEY = `manning_time_input_{{ session.id }}`;
            const timeInputModal = document.getElementById("timeInputModal");

            // ëª¨ë‹¬ ì—´ë¦´ ë•Œ: ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            timeInputModal.addEventListener("show.bs.modal", function () {
                loadInputData();
            });

            function loadInputData() {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (!savedData) return;

                try {
                    const data = JSON.parse(savedData);
                    const tbody = document.getElementById("time-input-rows");
                    const rows = tbody.querySelectorAll(".time-input-row");

                    // ì €ì¥ëœ ê°’ ì¹¸ì— ì±„ì›Œë„£ê¸°
                    data.rows.forEach((rowData, idx) => {
                        if (idx < rows.length) {
                            const row = rows[idx];
                            row.querySelector(".start-time").value =
                                rowData.start || "";
                            row.querySelector(".code").value =
                                rowData.code || "";
                            row.querySelector(".end-time").value =
                                rowData.end || "";
                        }
                    });

                    const workerSelect =
                        document.getElementById("worker-select");
                    if (data.worker_id) {
                        workerSelect.value = data.worker_id;
                    }
                } catch (e) {
                    console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
                }
            }

            // ì…ë ¥í•  ë•Œë§ˆë‹¤ ìë™ ì €ì¥ (LocalStorage)
            function setupAutoSave() {
                const tbody = document.getElementById("time-input-rows");
                tbody.addEventListener("input", saveToLocalStorage);
                document
                    .getElementById("worker-select")
                    .addEventListener("change", saveToLocalStorage);
            }

            function saveToLocalStorage() {
                const rows = document.querySelectorAll(
                    "#time-input-rows .time-input-row"
                );
                const rowData = [];
                rows.forEach((row) => {
                    rowData.push({
                        start: row.querySelector(".start-time").value,
                        code: row.querySelector(".code").value,
                        end: row.querySelector(".end-time").value,
                    });
                });
                const workerSelect = document.getElementById("worker-select");
                const data = {
                    worker_id: workerSelect.value,
                    rows: rowData,
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }

            setupAutoSave();

            // -----------------------------------------------------------
            // 3. [ì €ì¥í•˜ê¸°] ë²„íŠ¼ í´ë¦­ (ì„œë²„ ì „ì†¡)
            // -----------------------------------------------------------
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                    const cookies = document.cookie.split(";");
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (
                            cookie.substring(0, name.length + 1) ===
                            name + "="
                        ) {
                            cookieValue = decodeURIComponent(
                                cookie.substring(name.length + 1)
                            );
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function timeToMinutes(timeStr) {
                if (!timeStr || timeStr.length !== 4) return null;
                
                const h = parseInt(timeStr.substr(0, 2), 10);
                const m = parseInt(timeStr.substr(2, 2), 10);

                // [ìˆ˜ì •] 2400 (ìì •) í—ˆìš© -> 1440ë¶„
                if (h === 24 && m === 0) {
                    return 1440; 
                }

                // [ìˆ˜ì •] 0~23ì‹œ ì •ìƒ ì…ë ¥ í™•ì¸ (24ì‹œ ì´ìƒ ì…ë ¥ì€ ë°±ì—”ë“œ ë¡œì§ì´ ì•„ë‹Œ ì—¬ê¸°ì„œ 1ì°¨ë¡œ ë§‰ê±°ë‚˜ í—ˆìš©í•´ì•¼ í•¨)
                // ë§Œì•½ ì‚¬ìš©ìê°€ '2500'(ìƒˆë²½ 1ì‹œ)ìœ¼ë¡œ ì…ë ¥í•˜ëŠ” ìŠµê´€ì´ ìˆë‹¤ë©´ h > 23 ì œí•œì„ í’€ì–´ì•¼ í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” ì¼ë°˜ì ì¸ ì‹œê³„(00~23) ì…ë ¥ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ê³ , ì¢…ë£Œ ì‹œê°„ì´ ì‘ìœ¼ë©´ ë‹¤ìŒë‚ ë¡œ ì¸ì‹í•˜ê²Œ í•©ë‹ˆë‹¤.
                if (h < 0 || h > 23 || m < 0 || m > 59) {
                    return null; 
                }

                return h * 60 + m;
            }

            document
                .getElementById("save-times-btn")
                .addEventListener("click", function () {
                    const workerId =
                        document.getElementById("worker-select").value;
                    if (!workerId) {
                        alert("ì‘ì—…ìë¥¼ ì„ íƒí•˜ì„¸ìš”.");
                        return;
                    }

                    const rows = document.querySelectorAll(
                        "#time-input-rows .time-input-row"
                    );
                    const assignments = [];
                    let isValid = true;

                    rows.forEach((row, idx) => {
                        const startStr = row
                            .querySelector(".start-time")
                            .value.trim();
                        const code = row.querySelector(".code").value.trim();
                        const endStr = row
                            .querySelector(".end-time")
                            .value.trim();

                        if (!startStr && !endStr && !code) return; // ë¹ˆ ì¤„ íŒ¨ìŠ¤

                        if (!startStr || !endStr) {
                            alert(
                                `${idx + 1}ë²ˆ í–‰: ì‹œì‘/ì¢…ë£Œ ì‹œê°„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.`
                            );
                            isValid = false;
                            return;
                        }

                        const startMin = timeToMinutes(startStr);
                        const endMin = timeToMinutes(endStr);

                        if (startMin === null || endMin === null) {
                            alert(`${idx + 1}ë²ˆ í–‰: ì‹œê°„ í˜•ì‹ ì˜¤ë¥˜ (ì˜ˆ: 0900)`);
                            isValid = false;
                            return;
                        }

                        // "ëª¨ë‘" ì„ íƒ ì‹œ ì²˜ë¦¬
                        if (workerId === "all") {
                            const options = document.querySelectorAll(
                                "#worker-select option"
                            );
                            options.forEach((opt) => {
                                if (opt.value && opt.value !== "all") {
                                    assignments.push({
                                        type: "INDIRECT",
                                        start_min: startMin,
                                        end_min: endMin,
                                        code: code,
                                        worker_id: parseInt(opt.value),
                                    });
                                }
                            });
                        } else {
                            assignments.push({
                                type: "INDIRECT",
                                start_min: startMin,
                                end_min: endMin,
                                code: code,
                                worker_id: parseInt(workerId),
                            });
                        }
                    });

                    if (!isValid) return;

                    // ì„œë²„ ì „ì†¡
                    fetch("{% url 'save_manual_input' session.id %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken"),
                        },
                        body: JSON.stringify({ assignments: assignments }),
                    })
                        .then((r) => r.json())
                        .then((data) => {
                            if (data.status === "success") {
                                // [ìˆ˜ì •] ìš”ì²­í•˜ì‹  ë©”ì‹œì§€ë¡œ ë³€ê²½
                                alert("ì €ì¥ì´ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.");

                                // ì €ì¥ ì„±ê³µ ì‹œ ì„ì‹œ ë°ì´í„° ì‚­ì œ
                                localStorage.removeItem(STORAGE_KEY);

                                // ìƒˆë¡œê³ ì¹¨
                                window.location.reload();
                            } else {
                                alert("ì €ì¥ ì‹¤íŒ¨: " + (data.message || "ì˜¤ë¥˜"));
                            }
                        })
                        .catch((err) => {
                            alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err);
                        });
                });

            // -----------------------------------------------------------
            // 4. í–‰ ì¶”ê°€/ì‚­ì œ ê¸°ëŠ¥
            // -----------------------------------------------------------
            document
                .getElementById("add-row-btn")
                .addEventListener("click", function () {
                    const tbody = document.getElementById("time-input-rows");
                    const newRow = document.createElement("tr");
                    newRow.className = "time-input-row";
                    newRow.innerHTML = `
                    <td><input type="text" class="form-control form-control-sm start-time" placeholder="0800" maxlength="4"></td>
                    <td><input type="text" class="form-control form-control-sm code" placeholder="ì½”ë“œ"></td>
                    <td><input type="text" class="form-control form-control-sm end-time" placeholder="1000" maxlength="4"></td>
                    <td><button type="button" class="btn btn-sm btn-danger delete-row" onclick="deleteRow(this)">âœ•</button></td>
                `;
                    tbody.appendChild(newRow);
                });

            window.deleteRow = function (btn) {
                const rows = document.querySelectorAll(
                    "#time-input-rows .time-input-row"
                );
                if (rows.length > 1) {
                    btn.closest("tr").remove();
                    saveToLocalStorage(); // ì‚­ì œ í›„ ìƒíƒœ ì €ì¥
                } else {
                    alert("ìµœì†Œ 1ê°œì˜ í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                }
            };
        </script>
    </body>
</html>
