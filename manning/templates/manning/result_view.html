{% extends "manning/base/base.html" %} 
{% load static %} 
{% block title %}ë°°ì • ê²°ê³¼ | {{ session.name }} {% endblock title %} 

{% block css %}
<link rel="stylesheet" href="{% static 'css/result_view.css' %}" />
{% endblock css %} 

{% block js %}
<script defer src="{% static 'js/result_view.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get("reassigned") === "1") {
            const el = document.getElementById("reassignSuccessModal");
            if (el && window.bootstrap) {
                const modal = new window.bootstrap.Modal(el);
                modal.show();
            }
        }
    });
</script>
{% endblock js %} 

{% block background_image %} 
    {% include "manning/image/background_url.html" with bg_key="result_view" bg_default="https://picsum.photos/id/400/1600/900?grayscale&blur=2" %} 
{% endblock background_image %} 

{% block content %}
<div class="rounded-3 glass-panel" data-aos="fade-up" data-aos-duration="1000">
    <div
        class="d-flex flex-wrap justify-content-between align-items-center py-4 gap-3"
    >
        <h2 class="fw-bold text-dark">
            ğŸ“Š {{ session.name }} 
            
            {% if not session.is_active %}
            <span class="badge text-bg-secondary ms-2 " style="font-size: 1rem"
                >ì‘ì—… ì™„ë£Œ</span
            >
            {% else %}
            <span class="badge text-bg-primary ms-2" style="font-size: 1rem"
                >ì‘ì—… ì¤‘</span
            >
            {% endif %}
        </h2>
    </div>

    <div
        class="card border-0 shadow-lg rounded-3 mb-4 bg-white glass-panel"
        data-aos="fade-up"
    >
        <div
            class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3 p-4"
        >
            <div>
                <h5 class="fw-bold mb-1">ğŸš€ ì‘ì—… ë°°ì • ì»¨íŠ¸ë¡¤</h5>
                <p class="text-muted small mb-0">
                    ì‘ì—… ì™„ë£Œ ì‹œ ê¸°ë¡ ë³´ê´€ì†Œë¡œ ì´ë™í•©ë‹ˆë‹¤.
                </p>
            </div>
            <div class="d-flex gap-3">
                <div class="btn-group shadow-sm">
                    <a
                        href="{% url 'edit_session' session.id %}"
                        class="btn btn-secondary text-white fw-bold"
                    >
                        <i class="bi bi-people me-1"></i> ëª…ë‹¨ ê´€ë¦¬
                    </a>
                </div>
                <div class="btn-group shadow-sm">
                    <a
                        href="{% url 'manage_items' session.id %}"
                        class="btn btn-info text-dark fw-bold"
                    >
                        <i class="bi bi-list-task me-1"></i> í†µí•© ê´€ë¦¬
                    </a>
                </div>

                <form
                    id="finish-form"
                    action="{% url 'finish_session' session.id %}"
                    method="POST"
                >
                    {% csrf_token %}
                    <button
                        type="submit"
                        class="btn btn-dark btn-md rounded-3 fw-bold shadow-sm px-2"
                        onclick="
                            return confirm(
                                'ì •ë§ ì‘ì—…ì„ ì™„ë£Œí•˜ê³  ê¸°ë¡ ë³´ê´€ì†Œë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                            );
                        "
                    >
                        <i class="bi bi-check2-circle me-1"></i> ì‘ì—… ì™„ë£Œ
                        (í‡´ì‹¤)
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div
        class="card border-0 shadow-lg rounded-3 mb-5 overflow-hidden glass-panel"
        data-aos="fade-up"
        data-aos-delay="100"
    >
        <div class="card-header bg-white border-bottom pt-4 pb-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">
                    <i class="bi bi-person-gear text-primary me-2"></i>ì‘ì—…ì
                    í˜„í™© (M/H)
                </h5>
            </div>
        </div>

        <div class="card-body p-4">
            <form
                id="limitForm"
                action="{% url 'update_limits' session.id %}"
                method="POST"
            >
                {% csrf_token %}
                <div class="row g-3">
                    {% for worker in workers %}
                    <div class="col-6 col-md-4 col-lg-2">
                        <div
                            class="worker-card p-2 rounded-3 h-100 position-relative border border-primary glass-panel"
                        >
                            <div
                                class="d-flex justify-content-between align-items-start mb-1"
                            >
                                <span
                                    class="fw-bold text-dark text-truncate small"
                                    >{{ worker.name }}</span
                                >

                                {% if worker.used_mh > worker.limit_mh %}
                                <i
                                    class="bi bi-exclamation-circle-fill text-danger"
                                    style="font-size: 0.8rem"
                                    data-bs-toggle="tooltip"
                                    title="ì´ˆê³¼"
                                ></i>
                                {% endif %}
                            </div>

                            <div class="mb-2 text-center">
                                <span
                                    class="h6 fw-bold {% if worker.used_mh > worker.limit_mh %}text-danger{% else %}text-primary{% endif %} mb-0"
                                >
                                    {{ worker.used_mh|floatformat:1 }}
                                </span>
                                <span
                                    class="text-muted small"
                                    style="font-size: 0.7rem"
                                    >/</span
                                >

                                <input
                                    type="number"
                                    step="0.5"
                                    name="limit_{{ worker.id }}"
                                    class="form-control form-control-sm d-inline-block text-center fw-bold border-0 bg-light p-0"
                                    style="width: 45px; font-size: 0.85rem"
                                    value="{{ worker.limit_mh }}"
                                />
                            </div>

                            {% widthratio worker.used_mh worker.limit_mh 100 as ratio %}
                            <div class="progress" style="height: 4px">
                                <div
                                    class="progress-bar {% if worker.used_mh > worker.limit_mh %}bg-danger{% else %}bg-success{% endif %}"
                                    role="progressbar"
                                    style="width: {{ ratio }}%;"
                                ></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </form>
        </div>
    </div>

    <div
        class="d-flex justify-content-between align-items-center mb-3 px-1"
        data-aos="fade-up"
        data-aos-delay="200"
    >
        <h5 class="fw-bold mb-0 text-dark">
            ğŸ“‹ ì‘ì—… ìƒì„¸ ë‚´ì—­
            <span
                class="badge bg-secondary rounded-pill text-white border ms-2"
                style="font-size: 0.8rem"
            >
                {{ wo_total }}ê±´
            </span>
        </h5>
        <a
            href="{% url 'assigned_summary' session.id %}"
            class="btn btn-outline-primary btn-md rounded-3 glass-panel fw-bold px-3"
        >
            <i class="bi bi-calendar-range me-1"></i> ì‹œê°„ë³„ ë³´ê¸°
        </a>
    </div>

    <div
        class="card border-0 shadow-lg rounded-3 overflow-hidden glass-panel"
        data-aos="fade-up"
        data-aos-delay="200"
    >
        <div class="card-body p-0">
            <div class="table-responsive">
                <table
                    class="table table-custom table-sticky table-hover mb-0 text-center w-100" style="font-size: 0.9rem"
                >
                    <thead class="bg-light">
                        <tr>
                            <th class="col-gibun" style="width: 8%">ê¸°ë²ˆ</th>
                            <th class="col-wo" style="width: 10%">WO</th>
                            <th class="col-op" style="width: 8%">OP</th>
                            <th class="col-desc text-start">ì‘ì—… ì„¤ëª…</th>
                            <th class="col-mh" style="width: 8%">M/H</th>
                            <th class="col-assign" style="width: 40%">
                                ë°°ì • ê²°ê³¼
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %} {% if item.work_order != 'ê°„ë¹„' %}
                        <tr
                            class="{% if item.is_manual %}bg-soft-warning{% endif %}"
                        >
                            <td class="col-gibun fw-bold text-dark">
                                {{ item.gibun_input }}
                            </td>
                            <td class="col-wo">
                                <span class="badge bg-light text-dark border"
                                    >{{ item.work_order }}</span
                                >
                            </td>
                            <td class="col-op text-muted">{{ item.op }}</td>
                            <td
                                class="col-desc text-start desc-hide"
                                title="{{ item.description }}"
                            >
                                {{ item.description }}
                            </td>
                            <td class="col-mh">
                                <span class="badge bg-soft-primary text-primary"
                                    >{{ item.work_mh }}H</span
                                >
                            </td>
                            <td class="col-assign text-start">
                                {% for assign in item.assignments.all %}
                                <div class="d-inline-block me-1 mb-1">
                                    <span
                                        class="badge bg-white border border-secondary text-dark fw-normal shadow-sm"
                                    >
                                        <i
                                            class="bi bi-person-fill text-primary me-1"
                                        ></i
                                        >{{ assign.worker.name }}

                                        <span
                                            class="badge bg-primary rounded-pill ms-1"
                                        >
                                            {{ assign.allocated_mh|floatformat:1 }}H
                                        </span>
                                    </span>
                                </div>
                                {% empty %}
                                <span
                                    class="badge bg-light text-muted border border-dashed"
                                    >ë¯¸ë°°ì •</span
                                >
                                {% endfor %}
                            </td>
                        </tr>
                        {% endif %} {% empty %}
                        <tr>
                            <td colspan="7" class="py-5 text-muted">
                                ë“±ë¡ëœ ì‘ì—… ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="reassignSuccessModal"
    tabindex="-1"
    aria-hidden="true"
>
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-check-circle-fill me-2"></i>ì €ì¥ ë° ì¬ë°°ì •
                    ì™„ë£Œ
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">
                    ë³€ê²½ëœ ëª…ë‹¨/ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.
                </p>
            </div>
            <div class="modal-footer border-0">
                <button
                    type="button"
                    class="btn btn-success"
                    data-bs-dismiss="modal"
                >
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
