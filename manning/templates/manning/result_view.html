{% extends "manning/base/base.html" %}
{% load static %}

{% block title %}ë°°ì • ê²°ê³¼ | {{ session.name }}{% endblock title %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/result_view.css' %}">
{% endblock css %}

{% block js %}
    <script defer src="{% static 'js/result_view.js' %}"></script>
{% endblock js %}

{% block navsize %}{% endblock navsize %}
{% block navhome %}href="{% url 'index' %}"{% endblock navhome %} 
{% block navname %}<span>í™ˆ í˜ì´ì§€</span>{% endblock navname %} 
{% block navreturn %}
<a
    href="{% url 'session_list' %}"
    class="btn btn-outline-secondary btn-sm text-light border-secondary"
>
    <i class="bi bi-clock-history"></i>
    <span class="d-none d-md-inline">ë˜ëŒì•„ê°€ê¸°</span>
</a>
{% endblock navreturn %} 

{% block content %}
<div class="" style="padding-top: 100px;">    
    {% comment %} <div class="mt-4">
        <a href="{% url 'index' %}" class="fs-6 btn btn-primary btn-sm rounded-3 px-3 text-white fw-bold shadow-sm">
            <i class="bi bi-arrow-left"></i> í™ˆ í˜ì´ì§€
        </a>
        <span class="badge bg-soft-primary text-primary rounded-pill">Session ID: {{ session.id }}</span>
    </div> {% endcomment %}
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3" >
    
        {% comment %} <div class="d-flex align-items-center gap-2 mb-1">
            

            
        </div> {% endcomment %}

        <h2 class="fw-bold pt-3 mb-0 text-dark">ğŸ“Š {{ session.name }}</h2>

        <div class="d-flex gap-2">           
            
            <div class="btn-group shadow-sm">
                <a href="{% url 'edit_session' session.id %}" class="btn btn-white text-dark fw-bold border">
                    <i class="bi bi-people me-1"></i> ëª…ë‹¨ ê´€ë¦¬
                </a>
                <a href="{% url 'manage_items' session.id %}" class="btn btn-white text-dark fw-bold border">
                    <i class="bi bi-list-task me-1"></i> í†µí•© ê´€ë¦¬
                </a>
            </div>
            
            <button type="button" class="btn btn-success fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="bi bi-file-earmark-spreadsheet me-1"></i> ì—‘ì…€ ë“±ë¡
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-lg rounded-4 mb-4 bg-white" data-aos="fade-up">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3 p-4">
            <div>
                <h5 class="fw-bold mb-1">ğŸš€ ì‘ì—… ë°°ì • ì»¨íŠ¸ë¡¤</h5>
                <p class="text-muted small mb-0">ì‘ì—…ì í•œë„ë¥¼ ì„¤ì •í•œ í›„ ìë™ ë°°ì •ì„ ì‹¤í–‰í•˜ì„¸ìš”.</p>
            </div>
            <div class="d-flex gap-3">
                <form action="{% url 'trigger_auto_assign' session.id %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning btn-md rounded-3 fw-bold shadow-sm text-dark px-2">
                        <i class="bi bi-magic me-1"></i> ìë™ ë°°ì • ì‹¤í–‰
                    </button>
                </form>

                <form id="finish-form" action="{% url 'finish_session' session.id %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" 
                            class="btn btn-dark btn-md rounded-3 fw-bold shadow-sm px-2"
                            onclick="return confirm('ì •ë§ ì‘ì—…ì„ ì™„ë£Œí•˜ê³  ê¸°ë¡ ë³´ê´€ì†Œë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <i class="bi bi-check2-circle me-1"></i> ì‘ì—… ì™„ë£Œ (í‡´ì‹¤)
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-lg rounded-4 mb-5 overflow-hidden" data-aos="fade-up" data-aos-delay="100">
        <div class="card-header bg-white border-bottom pt-4 pb-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0"><i class="bi bi-person-gear text-primary me-2"></i>ì‘ì—…ì í˜„í™© (M/H)</h5>
                {% comment %} <button type="submit" form="limitForm" class="btn btn-sm btn-primary rounded-pill px-3 fw-bold">
                    <i class="bi bi-save me-1"></i> í•œë„ ì €ì¥
                </button> {% endcomment %}
            </div>
        </div>
        
        <div class="card-body p-4">
            <form id="limitForm" action="{% url 'update_limits' session.id %}" method="POST">
                {% csrf_token %}
                <div class="row g-3">
                    {% for worker in workers %}
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="worker-card p-2 rounded-3 h-100 position-relative border border-primary">
    
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <span class="fw-bold text-dark text-truncate small">{{ worker.name }}</span>
                                
                                {% if worker.used_mh > worker.limit_mh %}
                                    <i class="bi bi-exclamation-circle-fill text-danger" style="font-size: 0.8rem;" data-bs-toggle="tooltip" title="ì´ˆê³¼"></i>
                                {% endif %}
                            </div>

                            <div class="mb-2 text-center">
                                <span class="h6 fw-bold {% if worker.used_mh > worker.limit_mh %}text-danger{% else %}text-primary{% endif %} mb-0">
                                    {{ worker.used_mh|floatformat:1 }}
                                </span>
                                <span class="text-muted small" style="font-size: 0.7rem;">/</span>
                                
                                <input type="number" step="0.5" name="limit_{{ worker.id }}" 
                                    class="form-control form-control-sm d-inline-block text-center fw-bold border-0 bg-light p-0"
                                    style="width: 45px; font-size: 0.85rem;" value="{{ worker.limit_mh }}">
                            </div>

                            {% widthratio worker.used_mh worker.limit_mh 100 as ratio %}
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar {% if worker.used_mh > worker.limit_mh %}bg-danger{% else %}bg-success{% endif %}" 
                                    role="progressbar" style="width: {{ ratio }}%;"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </form>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 px-1" data-aos="fade-up" data-aos-delay="200">
        <h5 class="fw-bold mb-0 text-dark">ğŸ“‹ ì‘ì—… ìƒì„¸ ë‚´ì—­</h5>
        <a href="{% url 'assigned_summary' session.id %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="bi bi-calendar-range me-1"></i> ì‹œê°„ë³„ ë³´ê¸°
        </a>
    </div>

    <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5" data-aos="fade-up" data-aos-delay="200">
        <div class="card-body p-0">
            <div class="table">
                <table class="table table-custom table-sticky table-hover mb-0 text-center w-100">
                    <thead class="bg-light">
                        <tr>
                            <th style="width: 8%;">ê¸°ë²ˆ</th>
                            <th style="width: 10%;">WO</th>
                            <th style="width: 8%;">OP</th>
                            <th class="text-start">ì‘ì—… ì„¤ëª…</th>
                            <th style="width: 8%;">M/H</th>
                            <th style="width: 40%;">ë°°ì • ê²°ê³¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %} 
                            {% if item.work_order != 'ê°„ë¹„' %}
                            <tr class="{% if item.is_manual %}bg-soft-warning{% endif %}">
                                <td class="fw-bold text-dark">{{ item.gibun_input }}</td>
                                <td><span class="badge bg-light text-dark border">{{ item.work_order }}</span></td>
                                <td class="text-muted">{{ item.op }}</td>
                                <td class="text-start desc-hide" title="{{ item.description }}">
                                    {{ item.description }}
                                </td>
                                <td><span class="badge bg-soft-primary text-primary">{{ item.work_mh }}H</span></td>
                                <td class="text-start">
                                    {% for assign in item.assignments.all %}
                                        <div class="d-inline-block me-1 mb-1">
                                            <span class="badge bg-white border border-secondary text-dark fw-normal shadow-sm">
                                                <i class="bi bi-person-fill text-primary me-1"></i>{{ assign.worker.name }}
                                                
                                                <span class="badge bg-primary rounded-pill ms-1">
                                                    {{ assign.allocated_mh|floatformat:1 }}H
                                                </span>
                                            </span>
                                        </div>
                                    {% empty %}
                                        <span class="badge bg-light text-muted border border-dashed">ë¯¸ë°°ì •</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endif %} 
                        {% empty %}
                            <tr>
                                <td colspan="7" class="py-5 text-muted">ë“±ë¡ëœ ì‘ì—… ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-excel-fill me-2"></i>ì—‘ì…€ ë°ì´í„° ë“±ë¡</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form action="{% url 'upload_data' session.id %}" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-4 text-center">
                        <div class="mb-3">
                            <i class="bi bi-cloud-arrow-up text-success opacity-50" style="font-size: 4rem;"></i>
                        </div>
                        <p class="text-muted">.xlsx ë˜ëŠ” .xls íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                        <input type="file" class="form-control form-control-lg" name="file" accept=".xlsx, .xls" required>
                    </div>

                    <div class="alert alert-light border small text-muted">
                        <strong><i class="bi bi-info-circle me-1"></i>í•„ìˆ˜ ì»¬ëŸ¼ ìˆœì„œ:</strong><br>
                        ê¸°ì¢… | WO | OP | ì„¤ëª… | M/H
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg rounded-pill fw-bold shadow-sm">
                            ì—…ë¡œë“œ í•˜ê¸°
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}