<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‘ì—… ì‹œê°„ ì¼ê´„ ì…ë ¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: "Pretendard", sans-serif; background: #f8f9fa; }
        
        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-row input { text-align: center; border: none; background: transparent; width: 100%; outline: none; }
        .input-row input:focus { background: #e8f0fe; font-weight: bold; }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìƒ‰ìƒ */
        .res-direct { background-color: #d1e7dd; color: #0f5132; } 
        .res-indirect { background-color: #f8d7da; color: #842029; }
        
        /* ì™¼ìª½ í í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .queue-row { font-size: 0.85rem; }
        .queue-row.completed { background-color: #e9ecef; color: #adb5bd; text-decoration: line-through; }
        .queue-row.active { background-color: #e7f1ff; font-weight: bold; }
    </style>
</head>
<body class="p-3">

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
            <h4>â±ï¸ ì‘ì—… ì‹œê°„ ì¼ê´„ ì…ë ¥</h4>
            <div>
                <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">ë’¤ë¡œ ê°€ê¸°</a>
                <button class="btn btn-success btn-sm fw-bold" onclick="app.saveData()">ğŸ’¾ ì €ì¥ í•˜ê¸°</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-secondary text-white text-center py-2">
                        <h6 class="mb-0">ğŸ“‹ ë‚¨ì€ ì¼ê° (Queue)</h6>
                    </div>
                    <div class="card-body p-0" style="overflow-y: auto; max-height: 70vh;">
                        <table class="table table-sm table-bordered text-center mb-0 align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>WO</th>
                                    <th>OP</th>
                                    <th>M/H</th>
                                </tr>
                            </thead>
                            <tbody id="queueListArea">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">ğŸ•’ ì‹œê°„ ì…ë ¥</h6>
                        <button class="btn btn-sm btn-outline-dark" onclick="app.addInputRow()">+ í–‰ ì¶”ê°€</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-bordered text-center mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th width="25%">Start</th><th width="25%">Code (ê°„ë¹„)</th>
                                    <th width="25%">End</th><th width="10%">Del</th>
                                </tr>
                            </thead>
                            <tbody id="inputArea"></tbody>
                        </table>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <button class="btn btn-primary fw-bold px-4" onclick="app.calculate()">
                        ğŸ‘‡ ìë™ ë§¤í•‘ ì‹¤í–‰ (WO, OP ë°°ì •)
                    </button>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0">ğŸ“Š ìµœì¢… ê²°ê³¼</h6>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-bordered table-hover text-center mb-0">
                            <thead class="table-secondary">
                                <tr>
                                    <th>WO</th>
                                    <th>OP</th>
                                    <th>Type</th>
                                    <th>Start</th>
                                    <th>End</th>
                                </tr>
                            </thead>
                            <tbody id="resultArea">
                                <tr><td colspan="5" class="text-muted py-4">ëŒ€ê¸°ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        // CSRF í† í° ê°€ì ¸ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜ (Django ë³´ì•ˆ í•„ìˆ˜)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        class AutoManningSystem {
            
            constructor(items) {
                // ì›ë³¸ ë°ì´í„° ë³´ì¡´
                this.originalItems = JSON.parse(JSON.stringify(items));
                this.originalItems = JSON.parse(JSON.stringify(items));
                this.currentItems = JSON.parse(JSON.stringify(items));
                
                this.dom = {
                    queueList: document.getElementById('queueListArea'), // ì™¼ìª½ í (tbody)
                    inputTbody: document.getElementById('inputArea'),    // ì…ë ¥ì°½ (tbody)
                    resultTbody: document.getElementById('resultArea')   // ê²°ê³¼ì°½ (tbody)
                };

                this.renderQueue();
                
                // ê¸°ë³¸ 5ì¤„ ìƒì„±
                for (let i = 0; i < 5; i++) {
                    this.addInputRow();
                }
            }

            // [ì™¼ìª½] ë‚¨ì€ ì¼ê° í‘œì‹œ (WO | OP | M/H)
            renderQueue() {
                this.dom.queueList.innerHTML = "";
                this.currentItems.forEach(item => {
                    const isDone = item.remainMH <= 0.01;
                    const tr = document.createElement('tr');
                    tr.className = `queue-row ${isDone ? 'completed' : ''}`;
                    
                    // ì‹¤ì œ ë°ì´í„°(WO, OP)ë¥¼ ë³´ì—¬ì¤Œ
                    tr.innerHTML = `
                        <td><small class="text-muted">${item.model}</small><br>${item.wo}</td>
                        <td>${item.op}</td>
                        <td>${item.remainMH.toFixed(1)}</td>
                    `;
                    this.dom.queueList.appendChild(tr);
                });
            }

            // [ì˜¤ë¥¸ìª½ ìƒë‹¨] ì…ë ¥ í–‰ ì¶”ê°€ (ìˆ«ì 4ìë¦¬ ì œí•œ)
            addInputRow() {
                const tr = document.createElement('tr');
                tr.className = "input-row";
                const numberOnlyScript = "this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)";

                tr.innerHTML = `
                    <td class="p-0"><input type="text" class="start-time" maxlength="4" oninput="${numberOnlyScript}"></td>
                    <td class="p-0"><input type="text" class="indirect-code" maxlength="4" oninput="${numberOnlyScript}"></td>
                    <td class="p-0"><input type="text" class="end-time" maxlength="4" oninput="${numberOnlyScript}"></td>
                    <td class="p-1"><button class="btn btn-close btn-sm" onclick="this.closest('tr').remove()" tabindex="-1"></button></td>
                `;
                this.dom.inputTbody.appendChild(tr);
            }

            // â˜… [í•µì‹¬] ê³„ì‚° ë° ìë™ ë°°ì • ë¡œì§
            calculate() {
                // 1. ê³„ì‚° ì „ ìƒíƒœ ì´ˆê¸°í™” (ë‹¤ì‹œ ì²˜ìŒë¶€í„° ê³„ì‚°)
                this.currentItems = JSON.parse(JSON.stringify(this.originalItems));
                this.dom.resultTbody.innerHTML = "";
                
                const rows = this.dom.inputTbody.querySelectorAll("tr");
                let itemIndex = 0; // íì—ì„œ êº¼ë‚¼ ìˆœì„œ í¬ì¸í„°

                rows.forEach(row => {
                    const startStr = row.querySelector(".start-time").value;
                    const endStr = row.querySelector(".end-time").value;
                    const code = row.querySelector(".indirect-code").value.trim();

                    if (!startStr || !endStr) return;

                    let startMin = this.timeToMin(startStr);
                    let endMin = this.timeToMin(endStr);
                    if (endMin <= startMin) return;

                    // === A. ê°„ë¹„ ëª¨ë“œ (Code ì…ë ¥ë¨) ===
                    if (code !== "") {
                        // IDëŠ” null, CodeëŠ” ì „ë‹¬
                        this.appendResultRow(null, "", "", `ê°„ë¹„ (${code})`, sMin, endMin, "res-indirect", code);
                    } 
                    // === B. ì§ë¹„ ëª¨ë“œ (Code ê³µë€ -> ìë™ ë°°ì •) ===
                    else {
                        let slotDuration = endMin - startMin; 
                        let currentStart = startMin;

                        // ì‹œê°„ì´ ë‚¨ì•˜ê³  & ì¼ê°ì´ ë‚¨ì•„ìˆìœ¼ë©´ ë£¨í”„
                        while (slotDuration > 0 && itemIndex < this.currentItems.length) {
                            let item = this.currentItems[itemIndex];
                            
                            // ì´ë¯¸ ëë‚œ ì¼ê°ì€ íŒ¨ìŠ¤
                            if (item.remainMH <= 0.01) {
                                itemIndex++;
                                continue;
                            }

                            // ë°°ì •í•  ì‹œê°„ ê³„ì‚°
                            let allocateMin = Math.min(slotDuration, item.remainMH * 60);
                            let currentEnd = currentStart + allocateMin;

                            // â˜… [ì •ë‹µ ë¶€ë¶„] íì—ì„œ êº¼ë‚¸ item.woì™€ item.opë¥¼ ê²°ê³¼ì— ë„£ìŠµë‹ˆë‹¤.
                            // ì„¸ ë²ˆì§¸ ì¸ì(type)ëŠ” "ì§ë¹„"ë¼ê³  í‘œì‹œí•˜ê±°ë‚˜ ë¹„ì›Œë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            this.appendResultRow(item.id, item.wo, item.op, "ì§ë¹„", currentStart, currentEnd, "res-direct", null);

                            // ì”ì—¬ ì‹œê°„ ì°¨ê°
                            item.remainMH -= (allocateMin / 60);
                            slotDuration -= allocateMin;
                            currentStart = currentEnd;

                            // ì¼ê° ì™„ë£Œ ì‹œ ë‹¤ìŒ ì¼ê°ìœ¼ë¡œ
                            if (item.remainMH <= 0.01) {
                                item.remainMH = 0;
                                itemIndex++;
                            }
                        }

                        // ë‚¨ì€ ì‹œê°„ (ëŒ€ê¸°)
                        if (slotDuration > 0) {
                            this.appendResultRow("", "", "ëŒ€ê¸°", currentStart, currentStart + slotDuration, "table-light");
                        }
                    }
                });
                
                // í ìƒíƒœ ì—…ë°ì´íŠ¸ (ì¤„ì–´ë“  ì‹œê°„ ë°˜ì˜)
                this.renderQueue();
            }

            // â˜… [ìˆ˜ì •] appendResultRow: IDì™€ Codeë¥¼ datasetì— ì €ì¥
            appendResultRow(itemId, wo, op, typeText, sMin, eMin, cssClass, indirectCode) {
                const tr = document.createElement("tr");
                tr.className = cssClass;
                
                // â˜… ì„œë²„ ì „ì†¡ìš© ì¤‘ìš” ë°ì´í„° ìˆ¨ê¸°ê¸°
                if (itemId) tr.dataset.itemId = itemId;       // ì§ë¹„ì¼ ë•Œ ID
                if (indirectCode) tr.dataset.code = indirectCode; // ê°„ë¹„ì¼ ë•Œ ì½”ë“œ
                tr.dataset.start = sMin;
                tr.dataset.end = eMin;
                tr.dataset.type = indirectCode ? "INDIRECT" : (itemId ? "DIRECT" : "IDLE");

                const safeWO = wo ? wo : "&nbsp;";
                const safeOP = op ? op : "&nbsp;";
                const safeType = indirectCode ? indirectCode : "&nbsp;"; // ê°„ë¹„ì½”ë“œ ìë¦¬ì— í‘œì‹œ

                tr.innerHTML = `
                    <td>${safeWO}</td>
                    <td>${safeOP}</td>
                    <td>${safeType}</td>
                    <td>${this.minToTimeStr(sMin)}</td>
                    <td>${this.minToTimeStr(eMin)}</td>
                `;
                this.dom.resultTbody.appendChild(tr);
            }

            // â˜… [ì¶”ê°€] ì‹¤ì œ ì„œë²„ ì „ì†¡ ë¡œì§
            saveData() {
                const rows = this.dom.resultTbody.querySelectorAll("tr");
                if (rows.length === 0) {
                    alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const payload = [];
                rows.forEach(tr => {
                    // datasetì—ì„œ ë°ì´í„° ì¶”ì¶œ
                    const type = tr.dataset.type;
                    if (type === "IDLE") return; // ëŒ€ê¸° ì‹œê°„ì€ ì €ì¥ ì•ˆ í•¨ (í•„ìš”ì‹œ ìˆ˜ì •)

                    payload.push({
                        item_id: tr.dataset.itemId || null, // ì§ë¹„ ID
                        code: tr.dataset.code || null,      // ê°„ë¹„ ì½”ë“œ
                        start_min: parseInt(tr.dataset.start),
                        end_min: parseInt(tr.dataset.end),
                        type: type
                    });
                });

                // ì„œë²„ë¡œ ì „ì†¡ (AJAX)
                // URL ëì— í˜„ì¬ session IDê°€ ë“¤ì–´ê°€ì•¼ í•¨ (HTMLì—ì„œ ë³€ìˆ˜ë¡œ ë°›ì•„ì•¼ í•¨)
                const url = "{% url 'save_manual_input' session.id %}"; 

                fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie('csrftoken')
                    },
                    body: JSON.stringify({ assignments: payload })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert("âœ… ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        // ì €ì¥ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™ or ìƒˆë¡œê³ ì¹¨
                        window.location.href = "{% url 'result_view' session.id %}"; 
                    } else {
                        alert("ì €ì¥ ì‹¤íŒ¨: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
            }
        }

        // ì´ˆê¸°í™” ë¶€ë¶„
        const SERVER_DATA = {{ items_json|safe }};
        const app = new AutoManningSystem(SERVER_DATA);
    </script>

</body>
</html>