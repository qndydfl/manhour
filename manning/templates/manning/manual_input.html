<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <title>ì‘ì—… ì‹œê°„ ì¼ê´„ ì…ë ¥</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        />
        <link
            rel="stylesheet"
            as="style"
            crossorigin
            href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
        />
        <style>
            body {
                font-family: "Pretendard", sans-serif;
                background: #f8f9fa;
            }

            /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
            .input-row input {
                text-align: center;
                border: none;
                background: transparent;
                width: 100%;
                outline: none;
            }
            .input-row input:focus {
                background: #e8f0fe;
                font-weight: bold;
            }

            /* ê²°ê³¼ í…Œì´ë¸” ìƒ‰ìƒ */
            .res-direct {
                background-color: #d1e7dd;
                color: #0f5132;
            }
            .res-indirect {
                background-color: #f8d7da;
                color: #842029;
            }

            /* ì™¼ìª½ í í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
            .queue-row {
                font-size: 0.85rem;
            }
            .queue-row.completed {
                background-color: #e9ecef;
                color: #adb5bd;
                text-decoration: line-through;
            }
            .queue-row.active {
                background-color: #e7f1ff;
                font-weight: bold;
            }
        </style>
    </head>
    <body class="p-3">
        <div class="container-fluid">
            <div
                class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom"
            >
                <h4>â±ï¸ ì‘ì—… ì‹œê°„ ì…ë ¥</h4>
                <div>
                    <a
                        href="javascript:history.back()"
                        class="btn btn-outline-secondary btn-sm"
                        >ë’¤ë¡œ ê°€ê¸°</a
                    >
                    <button
                        class="btn btn-success btn-sm fw-bold"
                        onclick="app.saveData()"
                    >
                        ğŸ’¾ ì €ì¥ í•˜ê¸°
                    </button>
                </div>
            </div>

            <div class="row">
                <!-- 'í˜„ì¬ ë°ì´í„°' íŒ¨ë„ ì œê±°: ì‚¬ìš©ìê°€ ìš”ì²­í•¨ -->

                <div class="col-md-12">
                    <div class="card shadow-sm mb-4">
                        <div
                            class="card-header bg-white d-flex justify-content-between align-items-center"
                        >
                            <h6 class="mb-0 fw-bold">ğŸ•’ ì‹œê°„ ì…ë ¥</h6>
                            <button
                                class="btn btn-sm btn-outline-dark"
                                onclick="app.addInputRow()"
                            >
                                + í–‰ ì¶”ê°€
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <table
                                class="table table-bordered text-center mb-0 align-middle"
                            >
                                <thead class="table-light">
                                    <tr>
                                        <th width="25%">Start</th>
                                        <th width="25%">Code (ê°„ë¹„)</th>
                                        <th width="25%">End</th>
                                        <th width="10%">Del</th>
                                    </tr>
                                </thead>
                                <tbody id="inputArea"></tbody>
                            </table>
                        </div>
                    </div>                    
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>

            // CSRF í† í° ê°€ì ¸ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜ (Django ë³´ì•ˆ í•„ìˆ˜)
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            class AutoManningSystem {

                constructor(items, initialSelectedWorker) {
                    // ì›ë³¸ ë°ì´í„° ë³´ì¡´
                    this.originalItems = JSON.parse(JSON.stringify(items));
                    this.originalItems = JSON.parse(JSON.stringify(items));
                    this.currentItems = JSON.parse(JSON.stringify(items));

                    this.dom = {
                        queueList: document.getElementById('queueListArea'), // ì™¼ìª½ í (tbody)
                        inputTbody: document.getElementById('inputArea'),    // ì…ë ¥ì°½ (tbody)
                        resultTbody: document.getElementById('resultArea')   // ê²°ê³¼ì°½ (tbody)
                    };

                        this.selectedWorker = initialSelectedWorker && initialSelectedWorker.length ? initialSelectedWorker : null; // í˜„ì¬ ì„ íƒëœ ì‘ì—…ì ì´ë¦„ (í•„í„°)
                        this.renderQueue();
                        this.renderWorkerFilter();

                    // ê¸°ë³¸ 5ì¤„ ìƒì„±
                    for (let i = 0; i < 8; i++) {
                        this.addInputRow();
                    }
                }

                // [ì™¼ìª½] í˜„ì¬ ë°ì´í„° í‘œì‹œ (ì´ë¯¸ ë°°ì •ëœ í•­ëª© ì¤‘ì‹¬)
                renderQueue() {
                    if (!this.dom.queueList) return; // queueList removed from DOM when user requests
                    this.dom.queueList.innerHTML = "";
                    // show items that were passed from server (assigned items)
                    this.originalItems.forEach(item => {
                        const hasSelected = this.selectedWorker && item.assignments && item.assignments.some(a => a.worker === this.selectedWorker);
                        const tr = document.createElement('tr');
                        tr.className = `queue-row ${item.assignedMH > 0 ? 'active' : ''} ${hasSelected ? 'table-warning' : ''}`;

                        // build small badges for workers
                        let workerBadges = '';
                        if (item.assignments && item.assignments.length) {
                            workerBadges = item.assignments.map(a => `<span class="badge bg-light text-dark me-1 worker-badge" data-worker="${a.worker}" style="cursor:pointer">${a.worker}</span>`).join('');
                        }

                        tr.innerHTML = `
                            <td>${item.wo}</td>
                            <td>${item.op}</td>
                            <td class="text-truncate">${item.desc}</div></td>
                            <td class="text-end fw-bold">${(item.assignedMH || 0).toFixed(1)}</td>
                        `;
                        this.dom.queueList.appendChild(tr);
                    });

                    // attach click handlers to badges
                    this.dom.queueList.querySelectorAll('.worker-badge').forEach(b => {
                        b.addEventListener('click', (e) => {
                            const name = e.target.dataset.worker;
                            this.setSelectedWorker(name);
                        });
                    });
                }

                // worker filter UI (ì´ì œ í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì…ë ¥)
                renderWorkerFilter() {
                    const container = document.getElementById('workerFilter');
                    if (!container) return;
                    container.innerHTML = '';

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control form-control-sm';
                    input.placeholder = 'ì‘ì—…ì ì´ë¦„ ì…ë ¥ í›„ Enter ë˜ëŠ” ì¡°íšŒ ë²„íŠ¼';
                    input.style.width = '160px';
                    input.value = this.selectedWorker || '';
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.setSelectedWorker(input.value.trim() || null);
                        }
                    });
                    container.appendChild(input);

                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-light ms-1';
                    btn.textContent = 'ì¡°íšŒ';
                    btn.addEventListener('click', () => this.setSelectedWorker(input.value.trim() || null));
                    container.appendChild(btn);

                    const clear = document.createElement('button');
                    clear.className = 'btn btn-sm btn-outline-light ms-1';
                    clear.textContent = 'ì´ˆê¸°í™”';
                    clear.addEventListener('click', () => { input.value = ''; this.setSelectedWorker(null); });
                    container.appendChild(clear);
                }

                setSelectedWorker(name) {
                    this.selectedWorker = name;
                    // re-render queue to highlight
                    this.renderQueue();
                }

                // [ì˜¤ë¥¸ìª½ ìƒë‹¨] ì…ë ¥ í–‰ ì¶”ê°€ (ìˆ«ì 4ìë¦¬ ì œí•œ)
                addInputRow() {
                    const tr = document.createElement('tr');
                    tr.className = "input-row";
                    const numberOnlyScript = "this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)";

                    tr.innerHTML = `
                        <td class="p-0"><input type="text" class="start-time" maxlength="4" oninput="${numberOnlyScript}"></td>
                        <td class="p-0"><input type="text" class="indirect-code" maxlength="4" oninput="${numberOnlyScript}"></td>
                        <td class="p-0"><input type="text" class="end-time" maxlength="4" oninput="${numberOnlyScript}"></td>
                        <td class="p-1"><button class="btn btn-close btn-sm" onclick="this.closest('tr').remove()" tabindex="-1"></button></td>
                    `;
                    this.dom.inputTbody.appendChild(tr);
                }

                // â˜… [í•µì‹¬] ê³„ì‚° ë° ìë™ ë°°ì • ë¡œì§
                calculate() {
                    // 1. ì´ˆê¸°í™”
                    this.dom.resultTbody.innerHTML = "";

                    // 2. í• ë‹¹ ë‹¨ìœ„ í ìƒì„±: ê° WorkItemì˜ assignmentsë¥¼ ìˆœì„œëŒ€ë¡œ í‰íƒ„í™”
                        const assignmentQueue = [];
                        this.originalItems.forEach(item => {
                            if (item.assignments && item.assignments.length) {
                                item.assignments.forEach(a => {
                                    // í•„í„°: selectedWorkerê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì‘ì—…ìë§Œ í¬í•¨
                                    if (this.selectedWorker && a.worker !== this.selectedWorker) return;
                                    assignmentQueue.push({
                                        itemId: item.id,
                                        wo: item.wo,
                                        op: item.op,
                                        worker: a.worker,
                                        remainingMin: Math.round(a.allocatedMH * 60) // ë¶„ ë‹¨ìœ„ë¡œ
                                    });
                                });
                            }
                        });

                    const rows = this.dom.inputTbody.querySelectorAll("tr");

                    rows.forEach(row => {
                        const startStr = row.querySelector(".start-time").value;
                        const endStr = row.querySelector(".end-time").value;
                        const code = row.querySelector(".indirect-code").value.trim();

                        if (!startStr || !endStr) return;

                        let startMin = this.timeToMin(startStr);
                        let endMin = this.timeToMin(endStr);
                        if (endMin <= startMin) return;

                        // ê°„ë¹„ ì…ë ¥ì´ ìˆìœ¼ë©´ ê°„ë¹„ë¡œ ì²˜ë¦¬
                        if (code !== "") {
                            this.appendResultRow(null, "", "", null, `ê°„ë¹„ (${code})`, startMin, endMin, "res-indirect", code);
                            return;
                        }

                        // ì§ë¹„: íì—ì„œ ìˆœì„œëŒ€ë¡œ í• ë‹¹ëŸ‰ì„ ì±„ì›€
                        let slotDuration = endMin - startMin;
                        let cursor = startMin;

                        while (slotDuration > 0 && assignmentQueue.length > 0) {
                            const head = assignmentQueue[0];
                            const takeMin = Math.min(slotDuration, head.remainingMin);

                            // ê²°ê³¼ í–‰ ì¶”ê°€ (worker, item ë“±)
                            this.appendResultRow(head.itemId, head.wo, head.op, head.worker, "ì§ë¹„", cursor, cursor + takeMin, "res-direct", null);

                            // ê°ì†Œ
                            head.remainingMin -= takeMin;
                            slotDuration -= takeMin;
                            cursor += takeMin;

                            if (head.remainingMin <= 0) {
                                assignmentQueue.shift();
                            }
                        }

                        // ìŠ¬ë¡¯ì— ë‚¨ëŠ” ì‹œê°„ì€ ëŒ€ê¸°ë¡œ í‘œì‹œ
                        if (slotDuration > 0) {
                            this.appendResultRow(null, "", "", null, "ëŒ€ê¸°", cursor, cursor + slotDuration, "table-light", null);
                        }
                    });

                    // ë Œë”(ì¢Œì¸¡ ëª©ë¡ì€ ì„œë²„ ë°ì´í„° ê·¸ëŒ€ë¡œ í‘œì‹œ)
                    this.renderQueue();
                }

                // â˜… [ìˆ˜ì •] appendResultRow: IDì™€ Codeë¥¼ datasetì— ì €ì¥
                appendResultRow(itemId, wo, op, workerName, typeText, sMin, eMin, cssClass, indirectCode) {
                    const tr = document.createElement("tr");
                    tr.className = cssClass;

                    // â˜… ì„œë²„ ì „ì†¡ìš© ì¤‘ìš” ë°ì´í„° ìˆ¨ê¸°ê¸°
                    if (itemId) tr.dataset.itemId = itemId;       // ì§ë¹„ì¼ ë•Œ ID
                    if (indirectCode) tr.dataset.code = indirectCode; // ê°„ë¹„ì¼ ë•Œ ì½”ë“œ
                    if (workerName) tr.dataset.worker = workerName; // ì‘ì—…ì ì´ë¦„ (ì €ì¥ ì‹œ ì‚¬ìš©)
                    tr.dataset.start = sMin;
                    tr.dataset.end = eMin;
                    tr.dataset.type = indirectCode ? "INDIRECT" : (itemId ? "DIRECT" : "IDLE");

                    const safeWO = wo ? wo : "&nbsp;";
                    const safeOP = op ? op : "&nbsp;";
                    const safeWorker = workerName ? workerName : "&nbsp;";
                    const safeType = indirectCode ? indirectCode : (typeText ? typeText : "&nbsp;"); // ê°„ë¹„ì½”ë“œ ë˜ëŠ” íƒ€ì…

                    tr.innerHTML = `
                        <td>${safeWO}</td>
                        <td>${safeOP}</td>
                        <td>${safeWorker}</td>
                        <td>${safeType}</td>
                        <td>${this.minToTimeStr(sMin)}</td>
                        <td>${this.minToTimeStr(eMin)}</td>
                    `;
                    this.dom.resultTbody.appendChild(tr);
                }

                // ì‹œê°„ ë³€í™˜ ìœ í‹¸ (í´ë˜ìŠ¤ ë‚´ë¶€ ë©”ì„œë“œ)
                timeToMin(str) {
                    if(!str || str.length !== 4) return 0;
                    return (parseInt(str.substr(0,2))*60) + parseInt(str.substr(2,2));
                }

                minToTimeStr(min) {
                    let h = Math.floor(min / 60);
                    let m = min % 60;
                    return String(h).padStart(2,'0') + ":" + String(m).padStart(2,'0');
                }

                // â˜… [ì¶”ê°€] ì‹¤ì œ ì„œë²„ ì „ì†¡ ë¡œì§
                saveData() {
                    const rows = this.dom.resultTbody.querySelectorAll("tr");
                    if (rows.length === 0) {
                        alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    const payload = [];
                    rows.forEach(tr => {
                        // datasetì—ì„œ ë°ì´í„° ì¶”ì¶œ
                        const rowWorker = tr.dataset.worker || null;
                        const type = tr.dataset.type;
                        if (type === "IDLE") return; // ëŒ€ê¸° ì‹œê°„ì€ ì €ì¥ ì•ˆ í•¨ (í•„ìš”ì‹œ ìˆ˜ì •)

                        payload.push({
                            item_id: tr.dataset.itemId || null, // ì§ë¹„ ID
                            code: tr.dataset.code || null,      // ê°„ë¹„ ì½”ë“œ
                            start_min: parseInt(tr.dataset.start),
                            end_min: parseInt(tr.dataset.end),
                            worker: rowWorker,
                            type: type
                        });
                    });

                    // ì„œë²„ë¡œ ì „ì†¡ (AJAX)
                    // URL ëì— í˜„ì¬ session IDê°€ ë“¤ì–´ê°€ì•¼ í•¨ (HTMLì—ì„œ ë³€ìˆ˜ë¡œ ë°›ì•„ì•¼ í•¨)
                    const url = "{% url 'save_manual_input' session.id %}";

                    fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie('csrftoken')
                        },
                        body: JSON.stringify({ assignments: payload })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert("âœ… ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                            // ì €ì¥ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™ or ìƒˆë¡œê³ ì¹¨
                            window.location.href = "{% url 'result_view' session.id %}";
                        } else {
                            alert("ì €ì¥ ì‹¤íŒ¨: " + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    });
                }
            }

            // ì´ˆê¸°í™” ë¶€ë¶„
            const SERVER_DATA = {{ items_json|safe }};
            const INITIAL_SELECTED_WORKER = "{{ initial_selected_worker|escapejs }}";
            const app = new AutoManningSystem(SERVER_DATA, INITIAL_SELECTED_WORKER);
        </script>
    </body>
</html>
