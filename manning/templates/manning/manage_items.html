{% extends "manning/base/base.html" %} 
{% load static %} 

{% load widget_tweaks %} 

{% block title %}ÌÜµÌï© Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ - {{ session.name }}{% endblock title %} 

{% block css %} 
<link rel="stylesheet" href="{% static 'css/manage_items.css' %}" />
{% endblock css %} 

{% block js %}
<script>
    const PASTE_DATA_POST_URL = "{% url 'paste_items' session.id %}";
    const MASTER_DATA_LIST_URL = "{% url 'manage_items' session.id %}";
    const REORDER_ITEMS_URL = "{% url 'reorder_items' session.id %}";
</script>
<script defer src="{% static 'js/paste_data.js' %}"></script>
<script defer src="{% static 'js/manage_items.js' %}"></script>
{% endblock js %} 

{% block background_image %} 
{% include "manning/image/background_url.html" with bg_key="manage_items" bg_default="https://picsum.photos/id/500/1600/900?grayscale&blur=2" %} 
{% endblock background_image %} 

{% block content %}
<div class="d-flex justify-content-between align-items-center my-4 glass-panel rounded-3 p-4" style="max-width: 1000px;">
    <div class="d-flex align-items-center gap-3">
        <div>
            <h4 class="fw-bold mb-0 text-dark">
                <i class="bi bi-gear-wide-connected text-primary me-2"></i>
                Îç∞Ïù¥ÌÑ∞ ÌÜµÌï© Í¥ÄÎ¶¨
            </h4>
        </div>
    </div>

    <div class="d-flex gap-2">
        <button
            type="button"
            class="btn btn-primary fw-bold btn-sm rounded-pill px-2 shadow-sm"
            data-bs-toggle="modal"
            data-bs-target="#pasteDataModal"
        >
            <i class="bi bi-clipboard-plus me-1"></i>Îç∞Ïù¥ÌÑ∞ Îì±Î°ù
        </button>
    </div>
</div>
<div class="d-flex align-items-center text-dark small mb-3">
    <i class="bi bi-lightbulb-fill text-warning me-2 fs-5"></i>
    <strong>Î™®Îì† Ìï≠Î™©</strong>ÏùÑ ÏàòÏ†ï ÎòêÎäî ÏÇ≠Ï†ú ÌõÑ&nbsp;
    <span class="text-success fw-bold">"Ï†ÄÏû• Î∞è Ïû¨Î∞∞Ï†ï"</span>&nbsp;ÏùÑ
    ÎàåÎü¨Ï£ºÏÑ∏Ïöî.
</div>

<form
    method="POST"
    id="manage-form"
    action="{% url 'manage_items' session.id %}"
>
    {% csrf_token %} {{ formset.management_form }}

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div
                    class="card-header bg-white fw-bold border-bottom py-2"
                >
                    <i
                        class="bi bi-sort-numeric-down text-warning me-1"
                    ></i>
                    Í∏∞Ï¢Ö(Í∏∞Î≤à) Ïö∞ÏÑ†ÏàúÏúÑ
                </div>
                <div class="card-body p-0">
                    <div
                        class="table-responsive"
                        style="max-height: 200px; overflow-y: auto"
                    >
                        <table
                            class="table ios-table table-sm table-hover mb-0 text-center align-middle small"
                        >
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Í∏∞Ï¢Ö(Í∏∞Î≤à)</th>
                                    <th width="100">ÏàúÏúÑ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in gibun_priorities %}
                                <tr>
                                    <td class="fw-bold text-center ps-3">
                                        {{ p.gibun }}
                                    </td>
                                    <td>
                                        <input
                                            type="number"
                                            name="prio_{{ p.id }}"
                                            value="{{ p.order }}"
                                            class="form-control form-control-sm text-center fw-bold bg-light p-0 border-0"
                                            min="1"
                                        />
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-muted py-3">
                                        Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div
                    class="card-header bg-white fw-bold border-bottom py-2"
                >
                    <i class="bi bi-person-gear text-secondary me-1"></i>
                    Í∑ºÎ¨¥ ÌïúÎèÑ(M/H)
                </div>
                <div class="card-body p-0">
                    <textarea
                        name="worker_names_str"
                        class="form-control border-0 bg-light small font-monospace p-3 h-100"
                        style="min-height: 150px; resize: none"
                        placeholder="Ïù¥Î¶Ñ: ÏãúÍ∞Ñ (Ï§ÑÎ∞îÍøà)"
                    >{{ worker_names_str }}</textarea
                    >
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-5">
        <div
            class="card-header bg-white py-3 d-flex justify-content-between align-items-center sticky-top"
            style="z-index: 5; top: 0"
        >
            <div>
                <h5 class="fw-bold mb-0 d-inline-block">üìã Îç∞Ïù¥ÌÑ∞ Î™©Î°ù</h5>
                <span class="badge bg-secondary ms-2 rounded-pill"
                    >{{ non_common_count }}Í±¥</span
                >
            </div>
            <span class="text-danger small fw-bold"
                ><i class="bi bi-check-square me-1"></i>Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÑ†ÌÉù ÌõÑ
                Ï†ÄÏû• Ïãú ÏÇ≠Ï†úÎê©ÎãàÎã§.</span
            >
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table
                    id="manageItemsTable"
                    class="table table-hover mb-0 align-middle text-center"
                >
                    <thead
                        class="table-light sticky-top"
                        style="z-index: 4"
                    >
                        <tr class="text-secondary small">
                            <th
                                style="width: 5%"
                                class="text-danger col-delete"
                            >
                                <i class="bi bi-trash3-fill"></i>
                            </th>
                            <th style="width: 5%" class="col-order">
                                ÏàúÏÑú
                            </th>
                            <th style="width: 10%" class="col-gibun">
                                Í∏∞Î≤à
                            </th>
                            <th style="width: 14%" class="col-wo">W/O</th>
                            <th style="width: 6%" class="col-op">OP</th>
                            <th style="width: 10%" class="col-desc">ÏûëÏóÖ ÎÇ¥Ïö©</th>
                            <th style="width: 10%" class="col-mh">M/H</th>
                            <th
                                style="width: 40%"
                                class="bg-primary bg-opacity-10 text-primary col-assign"
                            >
                                Í≥†Ï†ï Î∞∞Ï†ï (Ïù¥Î¶Ñ)
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in formset %} {{ form.id }} 
                        {% for hidden in form.hidden_fields %} {{ hidden }} {% endfor %}

                        <input
                            type="hidden"
                            name="{{ form.prefix }}-ordering"
                            value="{{ form.instance.ordering|default:0 }}"
                        />

                        {% ifchanged form.instance.gibun_input %}
                        <tr
                            class="table-secondary border-bottom border-secondary group-header"
                            data-gibun="{{ form.instance.gibun_input|escape }}"
                        >
                            <td colspan="8" class="text-start py-2 px-3">
                                <div
                                    class="d-flex align-items-center justify-content-between"
                                >
                                    <div class="fw-bold text-dark fs-6">
                                        <i
                                            class="bi bi-airplane-engines-fill me-2"
                                        ></i
                                        >{{ form.instance.gibun_input|default:"(Í∏∞Î≤à ÏóÜÏùå)" }}
                                
                                    </div>

                                    <div>
                                        <a
                                            href="{% url 'reorder_gibun' session.id form.instance.gibun_input 'up' %}"
                                            class="btn btn-sm btn-outline-secondary border-0 p-0 me-1"
                                            title="Í∏∞Î≤à ÏúÑÎ°ú Ïù¥Îèô"
                                        >
                                            <i
                                                class="bi bi-arrow-up-circle-fill fs-5"
                                            ></i>
                                        </a>

                                        <a
                                            href="{% url 'reorder_gibun' session.id form.instance.gibun_input 'down' %}"
                                            class="btn btn-sm btn-outline-secondary border-0 p-0"
                                            title="Í∏∞Î≤à ÏïÑÎûòÎ°ú Ïù¥Îèô"
                                        >
                                            <i
                                                class="bi bi-arrow-down-circle-fill fs-5"
                                            ></i>
                                        </a>
                                    </div>

                                    <div
                                        class="form-check form-switch mb-0"
                                    >
                                        <input
                                            class="form-check-input"
                                            type="checkbox"
                                            id="chk_group_{{ forloop.counter }}"
                                            data-gibun="{{ form.instance.gibun_input|escape }}"
                                            onclick="
                                                toggleGroupDelete(this)
                                            "
                                            aria-label="Í∑∏Î£π Ï†ÑÏ≤¥ ÏÇ≠Ï†ú ÌÜ†Í∏Ä"
                                        />
                                        <label
                                            class="form-check-label small fw-bold text-danger"
                                            for="chk_group_{{ forloop.counter }}"
                                            >Í∑∏Î£π Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</label
                                        >
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endifchanged %}

                        <tr
                            class="{% if form.instance.work_order == 'Í∞ÑÎπÑ' %}d-none{% endif %} sortable-row"
                            data-item-id="{{ form.instance.pk }}"
                            data-gibun="{{ form.instance.gibun_input|escape }}"
                        >
                            <td class="text-danger col-delete">
                                {% if form.instance.pk %}
                                <div class="d-flex justify-content-center">
                                    <div class="d-none">
                                        {{ form.DELETE }}
                                    </div>
                                    <input
                                        type="checkbox"
                                        class="form-check-input delete-trigger item-chk-{{ form.instance.gibun_input|escape }}"
                                        data-gibun="{{ form.instance.gibun_input|escape }}"
                                        onchange="toggleDeleteRow(this)"
                                    />
                                </div>
                                {% endif %}
                            </td>
                            <td
                                class="text-danger col-order"
                                style="width: 40px"
                            >
                                {% if form.instance.pk %}
                                <div
                                    class="d-flex flex-column align-items-center lh-1"
                                >
                                    <span
                                        class="drag-handle text-muted mb-1"
                                        role="button"
                                        title="Ïó¨Í∏∞Î•º Ïû°ÏïÑ ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî"
                                        style="cursor: grab"
                                    >
                                        <i
                                            class="bi bi-grip-vertical fs-4"
                                        ></i>
                                    </span>
                                </div>
                                {% endif %}
                            </td>

                            <td class="col-gibun">
                                {% render_field form.gibun_input class="table-input fw-bold" placeholder="Í∏∞Î≤à" %}
                            </td>
                            <td class="col-wo">
                                {% render_field form.work_order class="table-input font-monospace" placeholder="WO" %}
                            </td>
                            <td class="col-op">
                                {% render_field form.op class="table-input" placeholder="OP" %}
                            </td>
                            <td class="col-desc">
                                {% render_field form.description class="table-input text-start desc-one-line" placeholder="ÏûëÏóÖ ÎÇ¥Ïö©" %}    
                            </td>
                            <td class="col-mh">
                                {% render_field form.work_mh class="table-input text-end fw-bold text-primary" step="0.1" %}
                            </td>
                            <td class="bg-primary bg-opacity-10 col-assign">
                                {% render_field form.assigned_text class="table-input fw-bold text-dark bg-transparent js-assigned-text" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td
                                colspan="8"
                                class="py-5 text-center text-muted"
                            >
                                Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</form>
</div>

<nav class="navbar navbar-expand-lg fixed-bottom py-3">
<div class="container justify-content-end align-items-center manage-footer">
    <div class="d-flex gap-2">
        <a
            href="{% url 'result_view' session.id %}"
            class="btn btn-secondary px-2"
            >Ï∑®ÏÜå</a
        >
        <button
            type="button"
            class="btn btn-outline-danger px-2"
            id="btn-clear-assigned"
        >
            Í≥†Ï†ï Î∞∞Ï†ï Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
        </button>
        <button
            type="submit"
            form="manage-form"
            class="btn btn-success fw-bold px-2 shadow"
        >
            <i class="bi bi-check-lg me-1"></i>Ï†ÄÏû• Î∞è Ïû¨Î∞∞Ï†ï
        </button>
    </div>
</div>
</nav>

<div class="modal fade" id="pasteDataModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">üìã Îç∞Ïù¥ÌÑ∞ ÏùºÍ¥Ñ Îì±Î°ù</h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <div class="modal-body p-4">
                <div class="instruction-box p-3 rounded-3 mb-4 bg-light border">
                    <h6 class="fw-bold text-primary mb-2">
                        <i class="bi bi-info-circle me-1"></i>Îç∞Ïù¥ÌÑ∞ ÏàúÏÑú (ÏóëÏÖÄ
                        Ïª¨Îüº)
                    </h6>
                    <div
                        class="d-flex flex-wrap gap-2 font-monospace small text-dark align-items-center"
                    >
                        <span
                            class="badge bg-white text-dark border shadow-sm px-2 py-1"
                            >1. Í∏∞Î≤à (HLxxxx)</span
                        >
                        <i class="bi bi-arrow-right text-muted"></i>
                        <span
                            class="badge bg-white text-dark border shadow-sm px-2 py-1"
                            >2. Work Order</span
                        >
                        <i class="bi bi-arrow-right text-muted"></i>
                        <span
                            class="badge bg-white text-dark border shadow-sm px-2 py-1"
                            >3. OP</span
                        >
                        <i class="bi bi-arrow-right text-muted"></i>
                        <span
                            class="badge bg-white text-dark border shadow-sm px-2 py-1"
                            >4. Description</span
                        >
                        <i class="bi bi-arrow-right text-muted"></i>
                        <span
                            class="badge bg-white text-dark border shadow-sm px-2 py-1"
                            >5. Work (M/H)</span
                        >
                    </div>
                </div>

                <form id="pasteForm">
                    {% csrf_token %}

                    <div class="table-responsive mb-4 border rounded-3">
                        <table
                            class="table table-bordered text-center align-middle mb-0 smart-table"
                            id="gridTable"
                        >
                            <thead>
                                <tr>
                                    <th style="width: 15%">Í∏∞Î≤à (Gibun)</th>
                                    <th style="width: 15%">Work Order</th>
                                    <th style="width: 10%">OP</th>
                                    <th style="width: 45%">
                                        ÏÑ§Î™Ö (Description)
                                    </th>
                                    <th style="width: 15%">Í∏∞Ï§Ä M/H</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-3">
                            <button
                                type="button"
                                onclick="addRow()"
                                class="btn btn-light w-100 fw-bold border text-muted rounded-pill"
                            >
                                <i class="bi bi-plus-lg"></i> Ï§Ñ Ï∂îÍ∞Ä
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button
                                type="reset"
                                class="btn btn-light w-100 fw-bold text-secondary rounded-pill"
                            >
                                Ï¥àÍ∏∞Ìôî
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button
                                type="button"
                                onclick="saveData()"
                                class="btn btn-primary w-100 fw-bold rounded-pill shadow-sm"
                            >
                                <i class="bi bi-save me-1"></i> Ï†ÄÏû• ÌïòÍ∏∞
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


{% endblock content %} {% block footer %}{% endblock footer %}
