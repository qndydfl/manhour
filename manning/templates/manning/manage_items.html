{% extends "manning/base/base.html" %}
{% load static %}

<title>{% block title %}ÌÜµÌï© Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ - {{ session.name }}{% endblock title %}</title>
{% block style %}<link rel="stylesheet" href="{% static 'css/manage_items.css' %}" />{% endblock style %}
{% block js %}<script defer src="{% static 'js/manage_items.js' %}"></script>{% endblock js %}


{% block main %}
    <div class="container p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            

            <div class="d-flex align-items-center gap-3">
                <div>
                    <h4 class="fw-bold mb-0">‚öôÔ∏èÌÜµÌï© Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ 
                        <span class="text-muted small">Session: {{ session.name }}</span>
                    </h4>
                </div>
                <a
                    href="{% url 'edit_session' session.id %}"
                    class="btn btn-sm btn-outline-secondary"
                >
                    <i class="bi bi-gear-fill"></i> ÏÑ§Ï†ï ÏàòÏ†ï
                </a>
            </div>
            
            
            
            <div class="d-flex gap-2">
                <a
                    href="{% url 'result_view' session.id %}"
                    class="btn btn-outline-secondary btn-sm rounded-pill px-3"
                >
                    <i class="bi bi-arrow-left"></i> ÎèåÏïÑÍ∞ÄÍ∏∞
                </a>
                <button
                    class="btn btn-outline-primary fw-bold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#excelImportArea"
                >
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i> ÏóëÏÖÄ
                    Î∂ôÏó¨ÎÑ£Í∏∞
                </button>
                <button
                    type="button"
                    class="btn btn-primary fw-bold"
                    data-bs-toggle="modal"
                    data-bs-target="#addItemModal"
                >
                    <i class="bi bi-plus-lg me-1"></i> Í∞úÎ≥Ñ Ï∂îÍ∞Ä
                </button>
            </div>
        </div>

        {% comment %} {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
            <div
                class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm"
                role="alert"
            >
                {{ message }}
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="alert"
                ></button>
            </div>
            {% endfor %}
        </div>
        {% endif %} {% endcomment %}

        <div class="collapse mb-4" id="excelImportArea">
            <div class="card border-primary shadow-sm">
                <div
                    class="card-header bg-primary bg-opacity-10 fw-bold text-primary"
                >
                    <i class="bi bi-clipboard-plus me-2"></i>ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞
                    ÏùºÍ¥Ñ Îì±Î°ù
                </div>
                <div class="card-body">
                    <form
                        action="{% url 'add_items_direct' session.id %}"
                        method="POST"
                    >
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-10 mb-2">
                                <label class="form-label small text-muted"
                                    >ÏóëÏÖÄ Î≥µÏÇ¨(Ctrl+C) -> Î∂ôÏó¨ÎÑ£Í∏∞(Ctrl+V)
                                    (ÏàúÏÑú: Í∏∞Î≤à, WO, OP, ÏÑ§Î™Ö, ÏãúÍ∞Ñ)</label
                                >
                                <textarea
                                    name="raw_data"
                                    class="form-control font-monospace"
                                    style="
                                        height: 100px;
                                        font-size: 0.85rem;
                                    "
                                    placeholder="ÏòàÏãú: HL7777  WO123456  OP01  ÌÉÄÏù¥Ïñ¥ Ï†êÍ≤Ä  1.5"
                                ></textarea>
                            </div>
                            <div
                                class="col-md-2 d-flex align-items-end mb-2"
                            >
                                <button
                                    type="submit"
                                    class="btn btn-primary w-100 fw-bold py-4"
                                >
                                    <i class="bi bi-upload me-1"></i> ÏóÖÎ°úÎìú
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <form method="POST" id="manage-form">
            {% csrf_token %} {{ formset.management_form }}

            <div class="row g-4">
                <div class="col-lg-2 col-md-12">
                    <div class="sticky-sidebar d-flex flex-column gap-3">
                        <div class="card shadow-sm border-0">
                            <div
                                class="card-header bg-white fw-bold border-bottom d-flex justify-content-between align-items-center"
                            >
                                <span class="small"
                                    ><i
                                        class="bi bi-sort-numeric-down text-warning me-1"
                                    ></i
                                    >Í∏∞Ï¢Ö Ïö∞ÏÑ†ÏàúÏúÑ</span
                                >
                            </div>
                            <div class="card-body p-0">
                                <div
                                    class="table-responsive"
                                    style="
                                        max-height: 350px;
                                        overflow-y: auto;
                                    "
                                >
                                    <table
                                        class="table table-sm table-hover mb-0 text-center align-middle"
                                        style="font-size: 0.85rem"
                                    >
                                        <thead
                                            class="table-light sticky-top"
                                        >
                                            <tr>
                                                <th>Í∏∞Ï¢Ö(Í∏∞Î≤à)</th>
                                                <th width="60">ÏàúÏúÑ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for p in gibun_priorities %}
                                            <tr>
                                                <td
                                                    class="fw-bold text-primary text-start ps-3"
                                                >
                                                    {{ p.gibun }}
                                                </td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        name="prio_{{ p.id }}"
                                                        value="{{ p.order }}"
                                                        class="form-control form-control-sm text-center fw-bold bg-light p-0"
                                                        min="1"
                                                    />
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td
                                                    colspan="2"
                                                    class="text-muted small py-3"
                                                >
                                                    Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow-sm border-0">
                            <div
                                class="card-header bg-white fw-bold border-bottom"
                            >
                                <span class="small"
                                    ><i
                                        class="bi bi-person-gear text-secondary me-1"
                                    ></i
                                    >Í∑ºÎ¨¥ ÌïúÎèÑ</span
                                >
                            </div>
                            <div class="card-body p-2">
                                <textarea
                                    name="worker_limits"
                                    class="form-control font-monospace border-0 bg-light small"
                                    style="height: 150px; resize: none"
                                >
                                {{ worker_names_str }}
                            </textarea
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-10 col-md-12">
                    <div class="card shadow-sm border-0">
                        <div
                            class="card-header bg-white py-3 d-flex justify-content-between align-items-center"
                        >
                            <h5 class="fw-bold mb-0">
                                üìã Îç∞Ïù¥ÌÑ∞ Î™©Î°ù
                                <span
                                    class="badge bg-secondary ms-2 rounded-pill"
                                    style="font-size: 0.7em"
                                    >{{ formset|length }}Í±¥</span
                                >
                            </h5>
                            <span class="text-muted small"
                                ><i class="bi bi-info-circle me-1"></i
                                >Ï≤¥ÌÅ¨Î∞ïÏä§Î•º ÏÑ†ÌÉùÌïòÎ©¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.</span
                            >
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive table-custom">
                                <table
                                    class="table table-hover mb-0 align-middle text-center"
                                    style="table-layout: fixed; width: 100%"
                                >
                                    <thead
                                        class="table-light sticky-top"
                                        style="z-index: 5"
                                    >
                                        <tr>
                                            <th
                                                style="width: 40px"
                                                class="text-danger"
                                            >
                                                <i class="bi bi-trash3"></i>
                                            </th>
                                            <th style="width: 8%">ÏàúÏÑú</th>
                                            <th style="width: 8%">Í∏∞Î≤à</th>
                                            <th style="width: 15%">WO</th>
                                            <th style="width: 8%">OP</th>
                                            <th style="width: 25%">
                                                ÏûëÏóÖ ÎÇ¥Ïö©
                                            </th>
                                            <th style="width: 8%">M/H</th>
                                            <th
                                                class="bg-primary bg-opacity-10 text-primary"
                                                style="width: auto"
                                            >
                                                Í≥†Ï†ï Î∞∞Ï†ï (Ïù¥Î¶Ñ)
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for form in formset %} {{ form.id }} 
                                        {% for hidden in form.hidden_fields %} {{ hidden }}{% endfor %} 
                                        {% ifchanged form.instance.gibun_input %}
                                        <tr class="group-header">
                                            <td
                                                colspan="8"
                                                class="text-start py-2 px-3"
                                            >
                                                <div
                                                    class="d-flex align-items-center justify-content-between"
                                                >
                                                    <div
                                                        class="fw-bold text-primary fs-6"
                                                    >
                                                        <i
                                                            class="bi bi-airplane-engines me-2"
                                                        ></i
                                                        >{{ form.instance.gibun_input|default:"(Í∏∞Î≤à ÏóÜÏùå)"|escape }}
                                                    </div>
                                                    <div class="form-check">
                                                        <input
                                                            class="form-check-input"
                                                            type="checkbox"
                                                            id="chk_group_{{ forloop.counter }}"
                                                            data-gibun="{{ form.instance.gibun_input|escape }}"
                                                            onclick=" toggleGroupDelete( this,)"
                                                        />
                                                        <label
                                                            class="form-check-label small text-danger fw-bold user-select-none"
                                                            for="chk_group_{{ forloop.counter }}"
                                                        >
                                                            Í∑∏Î£π Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
                                                        </label>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endifchanged %}

                                        <tr
                                            class="align-middle {% if form.instance.work_order == 'Í∞ÑÎπÑ' %}d-none{% endif %}"
                                        >
                                            <td>
                                                {% if form.instance.pk %}
                                                <div
                                                    class="d-flex justify-content-center"
                                                >
                                                    <div
                                                        style="
                                                            display: none;
                                                        "
                                                    >
                                                        {{ form.DELETE }}
                                                    </div>
                                                    <input
                                                        type="checkbox"
                                                        class="form-check-input delete-trigger item-chk-{{ form.instance.gibun_input|escape }}"
                                                        data-gibun="{{ form.instance.gibun_input|escape }}"
                                                        onchange="
                                                            toggleDelete(
                                                                this,
                                                            )
                                                        "
                                                    />
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% comment %} {% if
                                                form.ordering %} {{
                                                form.ordering }} {% if
                                                form.ordering.errors %}
                                                <div
                                                    class="text-danger small"
                                                    style="
                                                        font-size: 0.7rem;
                                                    "
                                                >
                                                    {{
                                                    form.ordering.errors.0
                                                    }}
                                                </div>
                                                {% endif %} {% else %}
                                                <input
                                                    type="number"
                                                    name="{{ form.prefix }}-ordering"
                                                    class="form-control form-control-sm text-center fw-bold bg-light"
                                                    value="{{ form.instance.ordering|default:0 }}"
                                                />
                                                {% endif %} {% endcomment %}
                                                {% if form.instance.pk %}
                                                <div
                                                    class="d-flex flex-column align-items-center"
                                                >
                                                    <a
                                                        href="{% url 'reorder_item' form.instance.pk 'up' %}"
                                                        class="btn btn-link p-0 text-secondary lh-1"
                                                        title="ÏúÑÎ°ú"
                                                    >
                                                        <i
                                                            class="bi bi-caret-up-fill"
                                                        ></i>
                                                    </a>

                                                    <a
                                                        href="{% url 'reorder_item' form.instance.pk 'down' %}"
                                                        class="btn btn-link p-0 text-secondary lh-1"
                                                        title="ÏïÑÎûòÎ°ú"
                                                    >
                                                        <i
                                                            class="bi bi-caret-down-fill"
                                                        ></i>
                                                    </a>
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.gibun_input|escape}}
                                            </td>
                                            <td>{{ form.work_order }}</td>
                                            <td>{{ form.op }}</td>

                                            <td class="text-start px-2">
                                                <div
                                                    class="text-truncate-2"
                                                    title="{{ form.instance.description }}"
                                                >
                                                    {{ form.description }}
                                                </div>
                                            </td>

                                            <td>{{ form.work_mh }}</td>

                                            <td
                                                class="bg-light assign-cell"
                                            >
                                                {{ form.assigned_worker_name|escape }}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td
                                                colspan="8"
                                                class="py-5 text-center text-muted"
                                            >
                                                <i
                                                    class="bi bi-inbox fs-1 d-block mb-3 opacity-50"
                                                ></i>
                                                Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <nav
                class="navbar fixed-bottom bottom-action-bar py-3 shadow-lg"
            >
                <div
                    class="container justify-content-between align-items-center"
                >
                    <div class="d-flex align-items-center">
                        <span class="badge bg-secondary me-2">Tip</span>
                        <span class="text-muted small"
                            >Ïù¥Î¶ÑÏùÑ ÏßÅÏ†ë ÏûÖÎ†•ÌïòÎ©¥
                            <strong>Í≥†Ï†ï Î∞∞Ï†ï</strong>Îê©ÎãàÎã§. ÏÇ≠Ï†úÌïòÎ†§Î©¥
                            Ï≤¥ÌÅ¨ÌïòÏÑ∏Ïöî.</span
                        >
                    </div>
                    <div class="d-flex gap-2">
                        <a
                            href="{% url 'result_view' session.id %}"
                            class="btn btn-outline-secondary px-4"
                            >Ï∑®ÏÜå</a
                        >
                        <button
                            type="submit"
                            class="btn btn-primary fw-bold px-5 shadow-sm"
                        >
                            <i class="bi bi-check-lg me-1"></i> Ï†ÄÏû• Î∞è
                            Ïû¨Î∞∞Ï†ï
                        </button>
                    </div>
                </div>
            </nav>
            <div style="height: 60px"></div>
        </form>
    </div>

    <div
        class="modal fade"
        id="addItemModal"
        tabindex="-1"
        aria-hidden="true"
    >
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">‚ûï Îç∞Ïù¥ÌÑ∞ Í∞úÎ≥Ñ Ï∂îÍ∞Ä</h5>
                    <button
                        type="button"
                        class="btn-close btn-close-white"
                        data-bs-dismiss="modal"
                    ></button>
                </div>
                <div class="modal-body">
                    <form
                        action="{% url 'add_single_item' session.id %}"
                        method="POST"
                    >
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label fw-bold small"
                                >Í∏∞Î≤à
                                <span class="text-danger">*</span></label
                            >
                            <input
                                type="text"
                                name="gibun"
                                class="form-control"
                                placeholder="Ïòà: HL7777"
                                required
                            />
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-8">
                                <label class="form-label fw-bold small"
                                    >Work Order
                                    <span class="text-danger"
                                        >*</span
                                    ></label
                                >
                                <input
                                    type="text"
                                    name="wo"
                                    class="form-control"
                                    placeholder="Ïòà: WO123456"
                                    required
                                />
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold small"
                                    >OP</label
                                >
                                <input
                                    type="text"
                                    name="op"
                                    class="form-control"
                                    placeholder="Ïòà: 01"
                                />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small"
                                >ÏûëÏóÖ ÎÇ¥Ïö©</label
                            >
                            <input
                                type="text"
                                name="description"
                                class="form-control"
                                placeholder="ÏûëÏóÖ ÏÑ§Î™Ö ÏûÖÎ†•"
                            />
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label fw-bold small"
                                    >ÏãúÍ∞Ñ (M/H)</label
                                >
                                <input
                                    type="number"
                                    step="0.1"
                                    name="mh"
                                    class="form-control"
                                    value="0.0"
                                />
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold small"
                                    >Í≥†Ï†ï ÏûëÏóÖÏûê (ÏÑ†ÌÉù)</label
                                >
                                <input
                                    type="text"
                                    name="worker_name"
                                    class="form-control"
                                    placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•"
                                />
                            </div>
                        </div>
                        <div class="d-grid">
                            <button
                                type="submit"
                                class="btn btn-primary fw-bold"
                            >
                                Ï∂îÍ∞ÄÌïòÍ∏∞
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock main %}

